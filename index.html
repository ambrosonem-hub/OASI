<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Modulo Ordine di Servizio</title>
<style>
:root{--max-width:980px;--accent:#0b67ff;}
body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:#f5f7fb;color:#1f2937;padding:24px;display:flex;justify-content:center;flex-direction:column;align-items:center;}
.container{width:100%;max-width:var(--max-width);background:#fff;border-radius:12px;box-shadow:0 6px 24px rgba(20,30,60,.08);padding:20px;}
h1{text-align:center;margin-bottom:20px;}
.panel{background:#fbfdff;border:1px solid #e6eefb;padding:12px;border-radius:8px;margin-bottom:12px;}
label{display:block;font-weight:600;margin-bottom:6px;font-size:13px;}
.field{margin-bottom:12px;}
input,textarea,select{width:100%;padding:8px;border:1px solid #d1d9e6;border-radius:6px;font-size:14px;box-sizing:border-box;}
textarea{min-height:80px;resize:vertical;}
.btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;}
.btn.secondary{background:#fff;color:var(--accent);border:1px solid #cfe0ff;}
.summary{background:#fff;padding:12px;border-radius:8px;border:1px solid #eef2ff;}
table{width:100%;border-collapse:collapse;margin-top:6px;}
td,th{padding:8px;text-align:left;border-bottom:1px solid #f1f5f9;}
.right{text-align:right;}
.muted{color:#6b7280;font-size:13px;}
.firme-container{display:flex;gap:20px;margin-top:15px;flex-wrap:wrap;}
.firma-canvas{border:1px solid #000;width:100%;max-width:300px;height:150px;cursor:crosshair;background:#fff;}
.materiale-row{display:flex;gap:8px;margin-bottom:6px;}
.materiale-row input[type="text"]{flex:2;}
.materiale-row input[type="number"]{width:100px;}
</style>
</head>
<body>
<div class="container">
  <h1>ORDINE DI SERVIZIO</h1>
  <form id="moduloForm" autocomplete="off" onsubmit="return false;">
    <!-- Progetto / Struttura / Ente / Indirizzo -->
    <div class="panel">
      <div class="field"><label for="progetto">Progetto</label><select id="progetto"></select></div>
      <div class="field"><label for="struttura">Struttura</label><select id="struttura"></select></div>
      <div class="field"><label for="ente">Ente</label><select id="ente"></select></div>
      <div class="field"><label for="indirizzo">Indirizzo</label><select id="indirizzo"></select><span id="indirizzo-stampa" style="display:none;"></span></div>
    </div>

    <!-- Descrizione lavori -->
    <div class="panel">
      <div class="field"><label for="descrizione">Descrizione dei lavori</label><textarea id="descrizione" name="DESCRIZIONE" placeholder="Descrivi il lavoro svolto..."></textarea></div>

      <!-- Materiali dinamici -->
      <div class="field">
        <label>Materiale fornito</label>
        <div id="materiali-container"></div>
        <button type="button" class="btn secondary" id="aggiungi-materiale">+ Aggiungi materiale</button>
        <div class="small muted">Inserisci descrizione e prezzo del materiale fornito. I costi si sommano al riepilogo.</div>
      </div>

      <!-- Operatori, ore e metri quadrati -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="field"><label for="operatori">Numero operatori</label><input id="operatori" type="number" min="0" step="1" value="1"></div>
        <div class="field"><label for="totOre">Totale ore</label><input id="totOre" type="number" min="0" step="0.5" value="0"></div>
      </div>
      <div class="field"><label for="mq">Metri quadrati (mq)</label><input id="mq" type="number" min="0" step="0.1" value="0"></div>

      <!-- Tipologia lavoro -->
      <div class="field">
        <label>Tipologia lavoro</label>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <label><input type="checkbox" id="manutenzione_chk"> Manutenzione</label>
          <label><input type="checkbox" id="pulizie_chk"> Pulizie</label>
          <label><input type="checkbox" id="sanificazione_chk"> Sanificazione</label>
          <label><input type="checkbox" id="disinfestazione_chk"> Disinfestazione</label>
          <label><input type="checkbox" id="derattizzazione_chk"> Derattizzazione</label>
        </div>
        <div class="small muted" style="margin-top:6px; white-space:pre-line;">
          Riferimento costi:
          Manutenzione (€/ora per operatore)  € 25.00
          Pulizie (€/ora per operatore)        € 20.00
          Sanificazione (€/mq)                € 2.00
          Disinfestazione (€/mq)              € 4.50
          Derattizzazione (€/mq)              € 6.50
        </div>
      </div>
    </div>

    <!-- Riepilogo costi -->
    <div class="panel summary">
      <h3>Riepilogo costi</h3>
      <pre id="costiSelezionati"></pre>
      <table>
        <tbody>
          <tr><th>Subtotale</th><th class="right">€ <span id="subtotal">0.00</span></th></tr>
          <tr><td>IVA (22%)</td><td class="right">€ <span id="iva">0.00</span></td></tr>
          <tr><th>Totale</th><th class="right">€ <span id="total">0.00</span></th></tr>
        </tbody>
      </table>
    </div>

    <!-- Firme -->
    <div class="firme-container">
      <div>
        <label>Firma operatore</label>
        <canvas id="firmaOperatore" class="firma-canvas"></canvas>
        <button type="button" class="btn secondary" onclick="pulisciFirma('firmaOperatore')">Pulisci</button>
      </div>
      <div>
        <label>Firma cliente</label>
        <canvas id="firmaCliente" class="firma-canvas"></canvas>
        <button type="button" class="btn secondary" onclick="pulisciFirma('firmaCliente')">Pulisci</button>
      </div>
    </div>

    <!-- Bottoni -->
    <div style="margin-top:12px;display:flex;gap:8px;">
      <button type="button" class="btn" id="print">Stampa</button>
      <button type="button" class="btn secondary" id="exportJson">Esporta JSON</button>
    </div>
  </form>
</div>

<script>
// ================= Variabili =================
let datiIndirizzi = [];
const RATES={MANUTENZIONE:25,PULIZIE:20,SANIFICAZIONE:2,DISINFESTAZIONE:4.5,DERATTIZZAZIONE:6.5};
const progettoEl=document.getElementById('progetto');
const strutturaEl=document.getElementById('struttura');
const enteEl=document.getElementById('ente');
const indirizzoEl=document.getElementById('indirizzo');
const operatoriEl=document.getElementById('operatori');
const totOreEl=document.getElementById('totOre');
const mqEl=document.getElementById('mq');
const manutenzioneChk=document.getElementById('manutenzione_chk');
const pulizieChk=document.getElementById('pulizie_chk');
const sanificazioneChk=document.getElementById('sanificazione_chk');
const disinfestazioneChk=document.getElementById('disinfestazione_chk');
const derattizzazioneChk=document.getElementById('derattizzazione_chk');
const subtotalEl=document.getElementById('subtotal');
const ivaEl=document.getElementById('iva');
const totalEl=document.getElementById('total');
const costiSelezionatiEl=document.getElementById('costiSelezionati');
const materialiContainer=document.getElementById('materiali-container');
const aggiungiMaterialeBtn=document.getElementById('aggiungi-materiale');

// ================= Caricamento JSON =================
fetch('enti_strutture.json')
  .then(res=>res.json())
  .then(json=>{ datiIndirizzi=json; popolaProgetti(); })
  .catch(err=>{ console.error('Errore caricamento JSON',err); });

// ================= Popolamento =================
function popolaProgetti(){
  const progetti=[...new Set(datiIndirizzi.map(d=>d.Progetto))];
  progettoEl.innerHTML="<option value=''>SELEZIONARE</option>";
  progetti.forEach(p=>progettoEl.innerHTML+=`<option value="${p}">${p}</option>`);
}
function popolaStrutture(){
  const val=progettoEl.value;
  const strutture=[...new Set(datiIndirizzi.filter(d=>d.Progetto===val).map(d=>d.Struttura))];
  strutturaEl.innerHTML="<option value=''>SELEZIONARE</option>";
  strutture.forEach(s=>strutturaEl.innerHTML+=`<option value="${s}">${s}</option>`);
  enteEl.innerHTML="<option value=''>SELEZIONARE</option>";
  indirizzoEl.innerHTML="";
}
function popolaEnti(){
  const valProgetto=progettoEl.value;
  const valStruttura=strutturaEl.value;
  const enti=[...new Set(datiIndirizzi.filter(d=>d.Progetto===valProgetto && d.Struttura===valStruttura).map(d=>d.Ente))];
  enteEl.innerHTML="<option value=''>SELEZIONARE</option>";
  enti.forEach(e=>enteEl.innerHTML+=`<option value="${e}">${e}</option>`);
  indirizzoEl.innerHTML="";
}
function popolaIndirizzi(){
  const valProgetto=progettoEl.value;
  const valStruttura=strutturaEl.value;
  const valEnte=enteEl.value;
  const indirizzi=datiIndirizzi.filter(d=>d.Progetto===valProgetto && d.Struttura===valStruttura && d.Ente===valEnte).map(d=>d.Indirizzo);
  indirizzoEl.innerHTML="";
  indirizzi.forEach(i=>{ const opt=document.createElement('option'); opt.value=i; opt.textContent=i; indirizzoEl.appendChild(opt); });
}

// ================= Eventi cascata =================
progettoEl.addEventListener('change',()=>{ popolaStrutture(); });
strutturaEl.addEventListener('change',()=>{ popolaEnti(); });
enteEl.addEventListener('change',()=>{ popolaIndirizzi(); });

// ================= Materiali =================
function aggiungiMateriale(){
  const div=document.createElement('div'); div.className='materiale-row';
  div.innerHTML='<input type="text" placeholder="Descrizione"><input type="number" placeholder="€" value="0" min="0" step="0.01"><button type="button" class="btn secondary">X</button>';
  div.querySelector('button').addEventListener('click',()=>{div.remove(); calcolaTotale();});
  div.querySelectorAll('input').forEach(i=>i.addEventListener('input',calcolaTotale));
  materialiContainer.appendChild(div);
}
aggiungiMaterialeBtn.addEventListener('click',aggiungiMateriale);

// ================= Calcolo =================
function calcolaTotale(){
  let subtotal=0;
  const operatori=Math.max(0,Number(operatoriEl.value)||0);
  const ore=Math.max(0,Number(totOreEl.value)||0);
  const mq=Math.max(0,Number(mqEl.value)||0);

  if(manutenzioneChk.checked) subtotal+=RATES.MANUTENZIONE*operatori*ore;
  if(pulizieChk.checked) subtotal+=RATES.PULIZIE*operatori*ore;
  if(sanificazioneChk.checked) subtotal+=RATES.SANIFICAZIONE*mq;
  if(disinfestazioneChk.checked) subtotal+=RATES.DISINFESTAZIONE*mq;
  if(derattizzazioneChk.checked) subtotal+=RATES.DERATTIZZAZIONE*mq;

  const materialiPrezzi=[...materialiContainer.querySelectorAll('input[type=number]')].map(i=>parseFloat(i.value)||0);
  subtotal+=materialiPrezzi.reduce((a,b)=>a+b,0);

  const iva=subtotal*0.22;
  const total=subtotal+iva;
  subtotalEl.textContent=subtotal.toFixed(2);
  ivaEl.textContent=iva.toFixed(2);
  totalEl.textContent=total.toFixed(2);

  // Riepilogo
  let riassunto='';
  if(manutenzioneChk.checked) riassunto+=`Manutenzione € ${(RATES.MANUTENZIONE*operatori*ore).toFixed(2)}\n`;
  if(pulizieChk.checked) riassunto+=`Pulizie € ${(RATES.PULIZIE*operatori*ore).toFixed(2)}\n`;
  if(sanificazioneChk.checked) riassunto+=`Sanificazione € ${(RATES.SANIFICAZIONE*mq).toFixed(2)}\n`;
  if(disinfestazioneChk.checked) riassunto+=`Disinfestazione € ${(RATES.DISINFESTAZIONE*mq).toFixed(2)}\n`;
  if(derattizzazioneChk.checked) riassunto+=`Derattizzazione € ${(RATES.DERATTIZZAZIONE*mq).toFixed(2)}\n`;
  materialiContainer.querySelectorAll('.materiale-row').forEach(row=>{
    const desc=row.querySelector('input[type=text]').value;
    const prezzo=parseFloat(row.querySelector('input[type=number]').value)||0;
    if(desc) riassunto+=`${desc} € ${prezzo.toFixed(2)}\n`;
  });
  costiSelezionatiEl.textContent=riassunto;
}
operatoriEl.addEventListener('input',calcolaTotale);
totOreEl.addEventListener('input',calcolaTotale);
mqEl.addEventListener('input',calcolaTotale);
[manutenzioneChk,pulizieChk,sanificazioneChk,disinfestazioneChk,derattizzazioneChk].forEach(c=>c.addEventListener('change',calcolaTotale));

// ================= Firma =================
function abilitaFirma(canvasId){
  const canvas=document.getElementById(canvasId);
  const ctx=canvas.getContext('2d');
  let disegnando=false;
  canvas.width=300; canvas.height=150; ctx.lineWidth=2; ctx.lineCap='round';
  const start=(e)=>{ e.preventDefault(); disegnando=true; const rect=canvas.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-rect.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-rect.top; ctx.beginPath(); ctx.moveTo(x,y);}
  const draw=(e)=>{ if(!disegnando) return; e.preventDefault(); const rect=canvas.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-rect.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-rect.top; ctx.lineTo(x,y); ctx.stroke();}
  const stop=()=>{ disegnando=false; ctx.closePath();}
  canvas.addEventListener('mousedown',start); canvas.addEventListener('mousemove',draw); canvas.addEventListener('mouseup',stop); canvas.addEventListener('mouseleave',stop);
  canvas.addEventListener('touchstart',start,{passive:false}); canvas.addEventListener('touchmove',draw,{passive:false}); canvas.addEventListener('touchend',stop); canvas.addEventListener('touchcancel',stop);
}
function pulisciFirma(canvasId){ const canvas=document.getElementById(canvasId); canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height);}
document.addEventListener('DOMContentLoaded',()=>{ abilitaFirma('firmaOperatore'); abilitaFirma('firmaCliente'); });

// ================= Stampa / Export =================
document.getElementById('print').addEventListener('click',()=>{ calcolaTotale(); window.print(); });
document.getElementById('exportJson').addEventListener('click',()=>{
  calcolaTotale();
  const data=new FormData(document.getElementById('moduloForm'));
  const obj={};
  for(const [k,v] of data.entries()) obj[k]=v;
  obj.MANUTENZIONE=manutenzioneChk.checked; obj.PULIZIE=pulizieChk.checked; obj.SANIFICAZIONE=sanificazioneChk.checked; obj.DISINFESTAZIONE=disinfestazioneChk.checked; obj.DERATTIZZAZIONE=derattizzazioneChk.checked;
  obj.SUBTOTAL=subtotalEl.textContent; obj.IVA=ivaEl.textContent; obj.TOTAL=totalEl.textContent;
  obj.MATERIALI=[...materialiContainer.querySelectorAll('.materiale-row')].map(r=>({desc:r.querySelector('input[type=text]').value,prezzo:r.querySelector('input[type=number]').value}));
  const canvasOp=document.getElementById('firmaOperatore'); obj.FIRMA_OPERATORE=canvasOp.toDataURL();
  const canvasCl=document.getElementById('firmaCliente'); obj.FIRMA_CLIENTE=canvasCl.toDataURL();
  const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='modulo_compilato.json'; a.click(); URL.revokeObjectURL(url);
});
</script>
</body>
</html>
