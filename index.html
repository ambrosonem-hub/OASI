<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Modulo Ordine di Servizio — Web</title>
<style>
:root {
  --max-width: 980px;
  --gap: 12px;
  --accent: #0b67ff;
}
*, *::before, *::after { box-sizing: border-box; }

body {
  font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
  background: #f5f7fb;
  color: #1f2937;
  padding: 24px;
  display: flex;
  justify-content: center;
  flex-direction: column;
  align-items: center;
}
.container {
  width: 100%;
  max-width: var(--max-width);
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 6px 24px rgba(20,30,60,0.08);
  padding: 20px;
}
h1 { font-size: 20px; margin: 0 0 8px; text-align:center; }
p.lead { margin: 0 0 18px; color: #475569; }
form { display: grid; grid-template-columns: 1fr 320px; gap: 18px; }
.panel { background: #fbfdff; border: 1px solid #e6eefb; padding: 12px; border-radius: 8px; }
label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; }
.field { margin-bottom: 12px; }
select, input[type="text"], input[type="number"], textarea {
  width: 100%; padding: 8px; border: 1px solid #d1d9e6; border-radius: 6px; font-size: 14px;
}
textarea { min-height: 120px; resize: vertical; }
.small { font-size: 13px; color: #475569; }
.controls { display: flex; gap: 8px; align-items: center; }
.full { grid-column: 1/-1; }
.btn { background: var(--accent); color: #fff; padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; }
.btn.secondary { background: #fff; color: var(--accent); border: 1px solid #cfe0ff; }
.summary { background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #eef2ff; }
table { width: 100%; border-collapse: collapse; }
td, th { padding: 8px; text-align: left; border-bottom: 1px solid #f1f5f9; }
.right { text-align: right; }
.muted { color: #6b7280; font-size: 13px; }
.logo-container { text-align: center; margin-bottom: 10px; }
.logo-container img { max-width: 177px; max-height: 118px; height: auto; }
.header-info { text-align: center; font-size: 13px; line-height: 1.2; margin-bottom: 20px; }
.header-info .title { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
.firma-canvas { border: 1px solid #000; cursor: crosshair; background-color: #fff; width: 100%; max-width: 300px; height: 150px; display: block; margin-top: 5px; }
.firma-canvas-container { margin-bottom: 15px; }
.firme-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; width: 100%; margin-top: 15px; }
.firme-container > div { flex: 1 1 300px; }
.firma-canvas-container button { margin-top: 5px; }

/* Layout responsive web */
@media (max-width: 900px) {
  body { padding: 12px; }
  .container { padding: 10px; }
  form { display: block; gap: 12px; }
  .panel { width: 100%; margin-bottom: 12px; }
  #descrizione { min-height: 100px; }
  .firme-container { flex-direction: column; gap: 15px; }
  .firma-canvas { max-width: 100%; height: auto; }
  .summary div[style*="justify-content:flex-end"] { flex-wrap: wrap; gap: 6px; }
}

/* Stampa ottimizzata */
@media print {
  @page { size: A4 portrait; margin: 15mm; }
  body { padding: 0; background: #fff; font-size: 12pt; color: #000; }
  .container { max-width: 100%; box-shadow: none; border-radius: 0; padding: 10mm; }
  h1 { font-size: 16pt; }
  p.lead, label, .small, td, th, input, textarea, select { font-size: 11pt; }
  form { display: block; }
  .panel, .summary, .firme-container > div { page-break-inside: avoid; }
  #descrizione { min-height: 80px; font-size: 11pt; border: 1px solid #000; background: #fff; width: 100%; }
  .firma-canvas { width: 100%; max-width: 400px; height: auto; border: 1px solid #000; }
  .firme-container { display: block; margin-top: 20px; page-break-inside: avoid; }
  .btn, #calc, #reset, #exportJson, #print { display: none !important; }
}
</style>
</head>
<body>
<div class="container" role="main">
  <div class="logo-container"><img src="logo.jpg" alt="Logo Azienda"></div>
  <div class="header-info">
    <div class="title">Sede Legale:</div>
    <div>Via Municipio, n. 14 - 83040 Fontanarosa (AV)</div>
    <div>Info – 082545553</div>
    <div>Mail - irpinialogistica@gmail.com</div>
    <div>PEC irpinialogistica@pec.it</div>
    <div>C.F. / Partita IVA 03196380640</div>
  </div>
  <h1>ORDINE DI SERVIZIO</h1>
  <form id="moduloForm" autocomplete="off">
    <div>
      <div class="panel">
        <div class="field">
          <label for="progetto">Progetto</label>
          <select id="progetto" name="PROGETTO">
            <option value="">Seleziona progetto</option>
          </select>
        </div>
        <div class="field">
          <label for="struttura">Struttura</label>
          <select id="struttura" name="STRUTTURA"><option>SELEZIONARE</option></select>
        </div>
        <div class="field">
          <label for="ente">Ente</label>
          <select id="ente" name="ENTE"><option>SELEZIONARE</option></select>
        </div>
        <div class="field">
          <label for="indirizzo">Indirizzo</label>
          <input id="indirizzo" name="INDIRIZZO" type="text" placeholder="Via, Piazza, etc.">
        </div>
        <div class="field">
          <label for="descrizione">Descrizione lavoro svolto</label>
          <textarea id="descrizione" name="DESCRIZIONE" placeholder="Inserisci qui i dettagli del lavoro svolto..."></textarea>
        </div>
        <div class="field">
          <label for="operatori">Numero operatori</label>
          <input id="operatori" name="NUM_OPERATORI" type="number" min="0" step="1" value="1">
        </div>
        <div class="field">
          <label for="totOre">Totale ore</label>
          <input id="totOre" name="TOT_ORE" type="number" min="0" step="0.5" value="0">
        </div>
        <div class="field">
          <label for="mq">Metri quadrati (mq)</label>
          <input id="mq" name="MQ" type="number" min="0" step="0.1" value="0">
        </div>
        <div class="field">
          <label>Tipologia lavoro</label>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <label><input type="checkbox" id="manutenzione_chk" name="MANUTENZIONE_CHECK"> Manutenzione</label>
            <label><input type="checkbox" id="pulizie_chk" name="PULIZIE_CHECK"> Pulizie</label>
            <label><input type="checkbox" id="sanificazione_chk" name="SANIFICAZIONE_CHECK"> Sanificazione</label>
            <label><input type="checkbox" id="disinfestazione_chk" name="DISINFESTAZIONE_CHECK"> Disinfestazione</label>
            <label><input type="checkbox" id="derattizzazione_chk" name="DERATTIZZAZIONE_CHECK"> Derattizzazione</label>
          </div>
        </div>
      </div>
    </div>

    <aside class="panel">
      <h3>Riepilogo costi</h3>
      <div class="summary">
        <table>
          <tbody>
            <tr><td>Manutenzione</td><td class="right">€ <span id="rate_manutenzione">25.00</span></td></tr>
            <tr><td>Pulizie</td><td class="right">€ <span id="rate_pulizie">20.00</span></td></tr>
            <tr><td>Sanificazione</td><td class="right">€ <span id="rate_sanificazione">2.00</span></td></tr>
            <tr><td>Disinfestazione</td><td class="right">€ <span id="rate_disinfestazione">4.50</span></td></tr>
            <tr><td>Derattizzazione</td><td class="right">€ <span id="rate_derattizzazione">6.50</span></td></tr>
            <tr><th>Subtotale</th><th class="right">€ <span id="subtotal">0.00</span></th></tr>
            <tr><td>IVA (22%)</td><td class="right">€ <span id="iva">0.00</span></td></tr>
            <tr><th>Totale</th><th class="right">€ <span id="total">0.00</span></th></tr>
          </tbody>
        </table>
        <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
          <button type="button" class="btn" id="calc">Calcola</button>
          <button type="button" class="btn secondary" id="reset">Reset</button>
        </div>
      </div>
      <div style="margin-top:14px">
        <label class="small">Operatore di struttura (firma)</label>
        <input id="operatoreFirma" name="OPERATORE_FIRMA" type="text">
      </div>
      <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
        <button type="button" class="btn" id="print">Stampa / Salva PDF</button>
        <button type="button" class="btn secondary" id="exportJson">Esporta JSON</button>
      </div>
    </aside>

    <div class="firme-container">
      <div class="firma-canvas-container">
        <h3>Firma operatore</h3>
        <canvas id="firmaOperatore" class="firma-canvas"></canvas>
        <button type="button" class="btn secondary" onclick="pulisciFirma('firmaOperatore')">Pulisci firma</button>
      </div>
      <div class="firma-canvas-container">
        <h3>Firma cliente</h3>
        <canvas id="firmaCliente" class="firma-canvas"></canvas>
        <button type="button" class="btn secondary" onclick="pulisciFirma('firmaCliente')">Pulisci firma</button>
      </div>
    </div>
  </form>
</div>

<script>
const progettoEl=document.getElementById('progetto');
const strutturaEl=document.getElementById('struttura');
const enteEl=document.getElementById('ente');
const operatoriEl=document.getElementById('operatori');
const totOreEl=document.getElementById('totOre');
const mqEl=document.getElementById('mq');
const manutenzioneChk=document.getElementById('manutenzione_chk');
const pulizieChk=document.getElementById('pulizie_chk');
const sanificazioneChk=document.getElementById('sanificazione_chk');
const disinfestazioneChk=document.getElementById('disinfestazione_chk');
const derattizzazioneChk=document.getElementById('derattizzazione_chk');
const subtotalEl=document.getElementById('subtotal');
const ivaEl=document.getElementById('iva');
const totalEl=document.getElementById('total');

const RATES = { MANUTENZIONE:25, PULIZIE:20, SANIFICAZIONE:2, DISINFESTAZIONE:4.5, DERATTIZZAZIONE:6.5 };

// Funzione helper per popolare select
function popolaSelect(selectEl, items){
  selectEl.innerHTML = '<option value="">Seleziona</option>';
  items.forEach(item => {
    const opt = document.createElement('option');
    opt.value = item.id;
    opt.textContent = item.nome;
    selectEl.appendChild(opt);
  });
}

// Carica i dati dal JSON
fetch('enti_strutture.json')
  .then(response => {
    if (!response.ok) throw new Error('Impossibile caricare il file JSON.');
    return response.json();
  })
  .then(dati => {
    if(dati.progetti) popolaSelect(progettoEl, dati.progetti);
    if(dati.strutture) popolaSelect(strutturaEl, dati.strutture);
    if(dati.enti) popolaSelect(enteEl, dati.enti);
  })
  .catch(err => {
    console.error(err);
    alert("Errore nel caricamento dei dati JSON: " + err);
  });

// Funzioni di calcolo
function euro(n){ return Number(n||0).toFixed(2); }
document.getElementById('calc').addEventListener('click', calcola);
document.getElementById('reset').addEventListener('click', ()=>{
  document.getElementById('moduloForm').reset();
  subtotalEl.textContent='0.00'; ivaEl.textContent='0.00'; totalEl.textContent='0.00';
});
function calcola(){
  const operatori=Math.max(0,Number(operatoriEl.value)||0);
  const ore=Math.max(0,Number(totOreEl.value)||0);
  const mq=Math.max(0,Number(mqEl.value)||0);
  let subtotal=0;
  if(manutenzioneChk.checked) subtotal+=RATES.MANUTENZIONE*ore*operatori;
  if(pulizieChk.checked) subtotal+=RATES.PULIZIE*ore*operatori;
  if(sanificazioneChk.checked) subtotal+=RATES.SANIFICAZIONE*mq;
  if(disinfestazioneChk.checked) subtotal+=RATES.DISINFESTAZIONE*mq;
  if(derattizzazioneChk.checked) subtotal+=RATES.DERATTIZZAZIONE*mq;
  const iva=subtotal*0.22;
  const total=subtotal+iva;
  subtotalEl.textContent=euro(subtotal);
  ivaEl.textContent=euro(iva);
  totalEl.textContent=euro(total);
}

// Funzioni firma
function abilitaFirma(canvasId){
  const canvas=document.getElementById(canvasId);
  const ctx=canvas.getContext('2d');
  let disegnando=false;
  canvas.width=300; canvas.height=150; ctx.lineWidth=2; ctx.lineCap='round';
  function getXY(e){ const rect=canvas.getBoundingClientRect(); if(e.touches) return [e.touches[0].clientX-rect.left,e.touches[0].clientY-rect.top]; return [e.offsetX,e.offsetY]; }
  canvas.addEventListener('mousedown', e=>{ disegnando=true; const [x,y]=getXY(e); ctx.beginPath(); ctx.moveTo(x,y); });
  canvas.addEventListener('mousemove', e=>{ if(disegnando){ const [x,y]=getXY(e); ctx.lineTo(x,y); ctx.stroke(); }});
  canvas.addEventListener('mouseup', ()=>disegnando=false);
  canvas.addEventListener('mouseleave', ()=>disegnando=false);
  canvas.addEventListener('touchstart', e=>{ e.preventDefault(); disegnando=true; const [x,y]=getXY(e); ctx.beginPath(); ctx.moveTo(x,y); });
  canvas.addEventListener('touchmove', e=>{ e.preventDefault(); if(disegnando){ const [x,y]=getXY(e); ctx.lineTo(x,y); ctx.stroke(); }});
  canvas.addEventListener('touchend', ()=>disegnando=false);
}
function pulisciFirma(canvasId){ const canvas=document.getElementById(canvasId); canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height); }
['firmaOperatore','firmaCliente'].forEach(id=>abilitaFirma(id));
function canvasToImageForPrint(){
  ['firmaOperatore','firmaCliente'].forEach(id=>{
    const canvas=document.getElementById(id);
    if(!canvas || canvas.tagName==='IMG') return;
    const img=new Image();
    img.src=canvas.toDataURL("image/png");
    img.style.width=canvas.style.width||canvas.width+'px';
    img.style.height=canvas.style.height||canvas.height+'px';
    canvas.parentNode.replaceChild(img,canvas);
  });
}
document.getElementById('print').addEventListener('click', ()=>{
  calcola();
  canvasToImageForPrint();
  setTimeout(()=>window.print(),100);
});
document.getElementById('exportJson').addEventListener('click', ()=>{
  calcola();
  const data=new FormData(document.getElementById('moduloForm'));
  const obj={};
  for(const [k,v] of data.entries()) obj[k]=v;
  obj.MANUTENZIONE=manutenzioneChk.checked;
  obj.PULIZIE=pulizieChk.checked;
  obj.SANIFICAZIONE=sanificazioneChk.checked;
  obj.DISINFESTAZIONE=disinfestazioneChk.checked;
  obj.DERATTIZZAZIONE=derattizzazioneChk.checked;
  obj.SUBTOTAL=subtotalEl.textContent;
  obj.IVA=ivaEl.textContent;
  obj.TOTAL=totalEl.textContent;
  obj.DESCRIZIONE=data.get('DESCRIZIONE')||'';
  const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='modulo_compilato.json'; a.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
