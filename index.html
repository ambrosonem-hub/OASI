<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Modulo Ordine di Servizio — Web</title>
<style>
:root { --max-width: 980px; --gap: 12px; --accent: #0b67ff; }
body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background: #f5f7fb; color: #1f2937; padding: 24px; display: flex; justify-content: center; flex-direction: column; align-items: center; }
.container { width: 100%; max-width: var(--max-width); background: #fff; border-radius: 12px; box-shadow: 0 6px 24px rgba(20,30,60,0.08); padding: 20px; }
h1 { font-size: 20px; margin: 0 0 8px; text-align: center; }
p.lead { margin:0 0 18px; color:#475569; }
form { display: grid; grid-template-columns:1fr 320px; gap:18px; }
.panel { background:#fbfdff; border:1px solid #e6eefb; padding:12px; border-radius:8px; page-break-inside: avoid; }
label { display:block; font-size:13px; font-weight:600; margin-bottom:6px; }
.field { margin-bottom:12px; }
select, input[type="text"], input[type="number"], textarea { width:100%; padding:8px; border:1px solid #d1d9e6; border-radius:6px; font-size:14px; box-sizing:border-box; }
textarea { min-height:80px; resize: vertical; }
.small { font-size:13px; color:#475569; }
.full { grid-column:1/-1; }
.btn { background:var(--accent); color:#fff; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
.btn.secondary { background:#fff; color:var(--accent); border:1px solid #cfe0ff; }
.summary { background:#fff; padding:12px; border-radius:8px; border:1px solid #eef2ff; }
table { width:100%; border-collapse:collapse; }
td, th { padding:8px; text-align:left; border-bottom:1px solid #f1f5f9; }
.right { text-align:right; }
.muted { color:#6b7280; font-size:13px; }
.logo-container { text-align:center; margin-bottom:10px; }
.logo-container img { max-width:177px; max-height:118px; height:auto; }
.header-info { text-align:center; font-size:13px; line-height:1.2; margin-bottom:20px; }
.header-info .title { font-size:16px; font-weight:bold; margin-bottom:5px; }
.header-info div { margin:0; }
.firma-canvas { border:1px solid #000; cursor:crosshair; background-color:#fff; width:100%; max-width:300px; height:150px; box-sizing:border-box; display:block; margin-top:5px; }
.firma-canvas-container { margin-bottom:15px; }
.firme-container { display:flex; flex-wrap:wrap; gap:20px; justify-content:space-between; width:100%; margin-top:15px; }
.firme-container > div { flex:1 1 300px; }
.firma-canvas-container button { margin-top:5px; }

@media (max-width:900px) {
  body { padding:12px; }
  .container { padding:10px; }
  form { grid-template-columns:1fr; }
  .firme-container { flex-direction:column; }
  .firma-canvas-container { width:100%; }
  .firma-canvas { max-width:100%; }
}

@media print {
  @page { size:A4 portrait; margin:10mm; }
  body { padding:0; background:#fff; }
  .container { max-width:100%; box-shadow:none; border-radius:0; padding:0; transform:scale(0.85); transform-origin:top left; }
  h1 { font-size:16pt; text-align:center; }
  p.lead, label, .small, td, th, input, textarea, select { font-size:10pt; }
  .btn, #calc, #reset, #exportJson, #print, .firma-canvas-container button { display:none !important; }
  .summary table { width:100%; font-size:10pt; }
  .panel, .firma-canvas-container { page-break-inside: avoid; }
  .firma-canvas { width:200px !important; height:100px !important; }
  .firme-container { display:flex; flex-wrap:wrap; gap:10px; justify-content:flex-start; }
}
</style>
</head>
<body>
<div class="container" role="main">

  <div style="margin-bottom:12px; text-align:right;">
    <button type="button" class="btn secondary" id="reloadJson">Aggiorna dati JSON</button>
  </div>

  <div class="logo-container">
    <img src="logo.jpg" alt="Logo Azienda" />
  </div>
  <div class="header-info">
    <div class="title">Sede Legale:</div>
    <div>Via Municipio, n. 14 - 83040 Fontanarosa (AV)</div>
    <div>Info – 082545553</div>
    <div>Mail - irpinialogistica@gmail.com</div>
    <div>PEC irpinialogistica@pec.it</div>
    <div>C.F. / Partita IVA 03196380640</div>
  </div>

  <h1>ORDINE DI SERVIZIO</h1>

  <form id="moduloForm" autocomplete="off">
    <!-- Qui inserisci tutto il contenuto del modulo (campi, riepilogo, firme) come nella tua versione originale -->
  </form>
</div>

<script>
let dati = [];
function caricaDati() {
  fetch("enti_strutture.json?nocache=" + Date.now())
    .then(r => r.json())
    .then(json => { dati=json; popolaProgetti(); aggiornaCascata(); })
    .catch(err => { console.error(err); alert("Errore caricamento JSON"); });
}
caricaDati();

document.getElementById('reloadJson').addEventListener('click', ()=>{
  caricaDati();
  alert("Dati JSON aggiornati correttamente!");
});

function popolaProgetti() {
  const progettoSelect = document.getElementById("progetto");
  if(!progettoSelect) return;
  const progettiUnici=[...new Set(dati.map(d=>d.Progetto))];
  progettoSelect.innerHTML="<option value=''>Seleziona progetto</option>";
  progettiUnici.forEach(p=>progettoSelect.innerHTML+=`<option value="${p}">${p}</option>`);
}

function aggiornaCascata(){
  const progettoEl=document.getElementById('progetto');
  const strutturaEl=document.getElementById('struttura');
  const enteEl=document.getElementById('ente');
  const val=progettoEl.value||'SELEZIONARE';
  if(dati && Array.isArray(dati) && dati.length>0){
    const strutture=[...new Set(dati.filter(d=>d.Progetto===val).map(d=>d.Struttura))];
    if(strutture.length===0) strutture.push('SELEZIONARE');
    popolaSelect(strutturaEl,strutture);
    popolaSelect(enteEl,['SELEZIONARE']);
    return;
  }
}
function popolaSelect(selectEl, items){
  selectEl.innerHTML='';
  items.forEach(it=>{ const opt=document.createElement('option'); opt.value=it; opt.textContent=it; selectEl.appendChild(opt); });
}

// --- Calcolo costi ---
const RATES={MANUTENZIONE:25, PULIZIE:20, SANIFICAZIONE:2, DISINFESTAZIONE:4.5, DERATTIZZAZIONE:6.5};
function euro(n){return Number(n||0).toFixed(2);}
function calcola(){
  const operatori=Math.max(0,Number(document.getElementById('operatori').value)||0);
  const ore=Math.max(0,Number(document.getElementById('totOre').value)||0);
  const mq=Math.max(0,Number(document.getElementById('mq').value)||0);
  let subtotal=0;
  if(document.getElementById('manutenzione_chk').checked) subtotal+=RATES.MANUTENZIONE*ore*operatori;
  if(document.getElementById('pulizie_chk').checked) subtotal+=RATES.PULIZIE*ore*operatori;
  if(document.getElementById('sanificazione_chk').checked) subtotal+=RATES.SANIFICAZIONE*mq;
  if(document.getElementById('disinfestazione_chk').checked) subtotal+=RATES.DISINFESTAZIONE*mq;
  if(document.getElementById('derattizzazione_chk').checked) subtotal+=RATES.DERATTIZZAZIONE*mq;
  const iva=subtotal*0.22;
  const total=subtotal+iva;
  document.getElementById('subtotal').textContent=euro(subtotal);
  document.getElementById('iva').textContent=euro(iva);
  document.getElementById('total').textContent=euro(total);
  return {subtotal,iva,total};
}
document.getElementById('calc')?.addEventListener('click',calcola);

// --- Gestione firme ---
function abilitaFirma(canvasId){
  const canvas=document.getElementById(canvasId);
  const ctx=canvas.getContext('2d');
  let disegnando=false;
  canvas.width=300; canvas.height=150;
  ctx.lineWidth=2; ctx.lineCap='round';
  canvas.addEventListener('mousedown', e=>{ disegnando=true; ctx.beginPath(); ctx.moveTo(e.offsetX,e.offsetY); });
  canvas.addEventListener('mousemove', e=>{ if(disegnando){ ctx.lineTo(e.offsetX,e.offsetY); ctx.stroke(); } });
  canvas.addEventListener('mouseup', ()=>disegnando=false);
  canvas.addEventListener('mouseleave', ()=>disegnando=false);
  canvas.addEventListener('touchstart', e=>{ e.preventDefault(); disegnando=true; const rect=canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo(e.touches[0].clientX-rect.left, e.touches[0].clientY-rect.top); });
  canvas.addEventListener('touchmove', e=>{ e.preventDefault(); if(disegnando){ const rect=canvas.getBoundingClientRect(); ctx.lineTo(e.touches[0].clientX-rect.left, e.touches[0].clientY-rect.top); ctx.stroke(); } });
  canvas.addEventListener('touchend', ()=>disegnando=false);
}
document.addEventListener("DOMContentLoaded", function(){ abilitaFirma('firmaOperatore'); abilitaFirma('firmaCliente'); });

// --- Stampa ---
document.getElementById('print')?.addEventListener('click', ()=>{
  calcola();
  ['firmaOperatore','firmaCliente'].forEach(id=>{
    const canvas=document.getElementById(id);
    if(canvas){
      const img=new Image();
      img.src=canvas.toDataURL("image/png");
      img.style.width=canvas.width+'px';
      img.style.height=canvas.height+'px';
      canvas.parentNode.replaceChild(img, canvas);
    }
  });
  window.print();
});
</script>
</body>
</html>
