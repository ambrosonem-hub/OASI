<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ordine di Servizio</title>
<style>
:root { --max-width:980px; --gap:12px; --accent:#0b67ff; }
body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
       background:#f5f7fb; color:#1f2937; padding:24px;
       display:flex; justify-content:center; flex-direction:column; align-items:center; }
.container { width:100%; max-width:var(--max-width); background:#fff; border-radius:12px;
            box-shadow:0 6px 24px rgba(20,30,60,0.08); padding:20px; }
h1 { font-size:20px; margin:0 0 8px; text-align:center; }
form { display:grid; grid-template-columns:1fr 320px; gap:18px; }
.panel { background:#fbfdff; border:1px solid #e6eefb; padding:12px; border-radius:8px; }
label { display:block; font-size:13px; font-weight:600; margin-bottom:6px; }
.field { margin-bottom:12px; }
select,input[type="text"],input[type="number"],textarea,input[type="date"],input[type="time"] { width:100%; padding:8px; border:1px solid #d1d9e6; border-radius:6px; font-size:14px; box-sizing:border-box; }
textarea { min-height:80px; resize:vertical; }
.small { font-size:13px; color:#475569; }
.btn { background:var(--accent); color:#fff; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
.btn.secondary { background:#fff; color:var(--accent); border:1px solid #cfe0ff; }
.summary { background:#fff; padding:12px; border-radius:8px; border:1px solid #eef2ff; }
table { width:100%; border-collapse:collapse; }
td,th { padding:8px; text-align:left; border-bottom:1px solid #f1f5f9; }
td.right,th.right { text-align:right; }
.logo-container { text-align:center; margin-bottom:10px; }
.logo-container img { max-width:177px; max-height:118px; height:auto; }
.header-info { text-align:center; font-size:13px; line-height:1.2; margin-bottom:20px; }
.header-info .title { font-size:16px; font-weight:bold; margin-bottom:5px; }
.firme-container { display: flex; gap: 20px; justify-content: space-between; width: 100%; margin-top: 15px; flex-wrap: nowrap; }
.firma-canvas-container { flex: 1; max-width: 48%; position: relative; }
.firma-canvas { border:1px solid #000; cursor:crosshair; background-color:#fff; width:100%; height:150px; display:block; }
.firma-stampa { display:none; border:1px solid #000; width:100%; height:150px; pointer-events:none; }
.materiale-row { display:flex; gap:6px; margin-bottom:6px; }
.materiale-row input[type=text]{ flex:2; } .materiale-row input[type=number]{ flex:1; }
.istruzioni-costi { font-size:12px; color:#374151; margin-top:12px; line-height:1.3; }

@media(max-width:900px){ form{grid-template-columns:1fr} .firma-canvas{max-width:100%;} }
@media print{
  @page {size:A4 portrait;margin:15mm;}
  body {padding:0;background:#fff;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
  .container {width:100%; max-width:100%; box-shadow:none; border-radius:0; padding:0; display:block;}
  .btn,.firma-canvas-container button,.small.muted {display:none !important;}
  .firma-canvas { display: none !important; }
  .firma-stampa { display:block !important; width:150px; height:75px; margin-bottom:5px; }
}
</style>
</head>
<body>
<div class="container">
  <div class="logo-container"><img src="logo.jpg" alt="Logo Azienda"/></div>
  <div class="header-info">
    <div class="title">Sede Legale:</div>
    <div>Via Municipio, n. 14 - 83040 Fontanarosa (AV)</div>
    <div>Info – 082545553</div>
    <div>Mail - irpinialogistica@gmail.com</div>
    <div>PEC irpinialogistica@pec.it</div>
    <div>C.F. / Partita IVA 03196380640</div>
  </div>
  <h1>ORDINE DI SERVIZIO</h1>
  <form id="moduloForm" autocomplete="off">
    <div>
      <div class="panel">
        <div class="field"><label for="progetto">Progetto</label><select id="progetto"></select></div>
        <div class="field"><label for="struttura">Struttura</label><select id="struttura"></select></div>
        <div class="field"><label for="ente">Ente</label><select id="ente"></select></div>
        <div class="field"><label for="indirizzo">Indirizzo</label><select id="indirizzo"></select></div>
        <div class="field"><label for="descrizione">Descrizione dei lavori</label><textarea id="descrizione" placeholder="Descrivi il lavoro svolto..."></textarea></div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
          <div class="field"><label for="dataLavoro">Data lavoro</label><input id="dataLavoro" type="date"/></div>
          <div class="field"><label for="oraInizio">Ora inizio</label><input id="oraInizio" type="time"/></div>
          <div class="field"><label for="oraFine">Ora fine</label><input id="oraFine" type="time"/></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
          <div class="field"><label for="operatori">Numero operatori</label><input id="operatori" type="number" min="0" step="1" value="1"/></div>
          <div class="field"><label for="totOre">Totale ore</label><input id="totOre" type="number" min="0" step="0.5" value="0"/></div>
          <div class="field"><label for="mq">Metri quadrati (mq)</label><input id="mq" type="number" min="0" step="0.1" value="0"/></div>
        </div>
        <div class="field">
          <label>Tipologia lavoro</label>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <label><input type="checkbox" id="manutenzione_chk"/> Manutenzione</label>
            <label><input type="checkbox" id="pulizie_chk"/> Pulizie</label>
            <label><input type="checkbox" id="sanificazione_chk"/> Sanificazione</label>
            <label><input type="checkbox" id="disinfestazione_chk"/> Disinfestazione</label>
            <label><input type="checkbox" id="derattizzazione_chk"/> Derattizzazione</label>
          </div>
        </div>
        <div class="field">
          <label>Materiali forniti</label>
          <div id="materiali-container"></div>
          <button type="button" class="btn secondary" id="aggiungiMaterialeBtn">Aggiungi materiale</button>
        </div>
      </div>
    </div>
    <aside class="panel">
      <h3>Riepilogo costi</h3>
      <div class="summary">
        <table><tbody id="riepilogoBody"></tbody></table>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <span>Subtotale € <span id="subtotal">0.00</span></span> | 
          <span>IVA € <span id="iva">0.00</span></span> | 
          <span>Totale € <span id="total">0.00</span></span>
        </div>
      </div>
      <div class="istruzioni-costi">
        <b>COSTI DEL PERSONALE E DEI SERVIZI SVOLTI DA IRPINIA LOGISTICA SOCIETA’ COOP.SOC. ETS</b><br>
        - Il costo della manutenzione è di 25,00€ l’ora per singolo operatore<br>
        - Il costo del servizio di pulizia è di 20,00€ l’ora per singolo operatore<br>
        - Il costo della sanificazione a metro quadro è di 2,00€<br>
        - Il costo della disinfestazione a metro quadro è di 4,50€<br>
        - Il costo della derattizzazione a metro quadro è di 6,50€
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end;">
        <button type="button" class="btn" id="print">Stampa / Salva PDF</button>
        <button type="button" class="btn secondary" id="exportJson">Esporta (JSON)</button>
      </div>
    </aside>
    <div class="firme-container">
      <div class="firma-canvas-container">
        <h3>Firma operatore</h3>
        <canvas id="firmaOperatore" class="firma-canvas"></canvas>
        <img id="firmaOperatore_stampa" class="firma-stampa" />
        <input type="text" id="nomeOperatore" placeholder="Nome operatore" style="margin-top:5px;">
        <button type="button" class="btn secondary" onclick="pulisciFirma('firmaOperatore')">Pulisci firma</button>
        <div id="nomeOperatoreStampa" style="font-size:12px;"></div>
      </div>
      <div class="firma-canvas-container">
        <h3>Firma cliente</h3>
        <canvas id="firmaCliente" class="firma-canvas"></canvas>
        <img id="firmaCliente_stampa" class="firma-stampa" />
        <input type="text" id="nomeCliente" placeholder="Nome cliente" style="margin-top:5px;">
        <button type="button" class="btn secondary" onclick="pulisciFirma('firmaCliente')">Pulisci firma</button>
        <div id="nomeClienteStampa" style="font-size:12px;"></div>
      </div>
    </div>
  </form>
</div>

<script>
const RATES={MANUTENZIONE:25,PULIZIE:20,SANIFICAZIONE:2,DISINFESTAZIONE:4.5,DERATTIZZAZIONE:6.5};
const progettoEl=document.getElementById('progetto'), strutturaEl=document.getElementById('struttura'), enteEl=document.getElementById('ente'), indirizzoEl=document.getElementById('indirizzo');
const operatoriEl=document.getElementById('operatori'), totOreEl=document.getElementById('totOre'), mqEl=document.getElementById('mq');
const manutenzioneChk=document.getElementById('manutenzione_chk'), pulizieChk=document.getElementById('pulizie_chk'), sanificazioneChk=document.getElementById('sanificazione_chk'), disinfestazioneChk=document.getElementById('disinfestazione_chk'), derattizzazioneChk=document.getElementById('derattizzazione_chk');
const subtotalEl=document.getElementById('subtotal'), ivaEl=document.getElementById('iva'), totalEl=document.getElementById('total'), riepilogoBody=document.getElementById('riepilogoBody');
const materialiContainer=document.getElementById('materiali-container'), aggiungiMaterialeBtn=document.getElementById('aggiungiMaterialeBtn');
const nomeOperatoreInput=document.getElementById('nomeOperatore'), nomeClienteInput=document.getElementById('nomeCliente');
const nomeOperatoreStampa=document.getElementById('nomeOperatoreStampa'), nomeClienteStampa=document.getElementById('nomeClienteStampa');

let enti_strutture=[];

async function caricaEntiStrutture(){
  try{
    const resp=await fetch('enti_strutture.json');
    if(!resp.ok) throw new Error("Errore caricamento JSON");
    enti_strutture=await resp.json();
    popolaProgetti();
  } catch(e){console.error(e); alert("Impossibile caricare enti_strutture.json");}
}
function popolaProgetti(){
  const progetti=[...new Set(enti_strutture.map(d=>d.Progetto))];
  progettoEl.innerHTML="<option value=''>SELEZIONARE</option>";
  progetti.forEach(p=>progettoEl.innerHTML+=`<option value="${p}">${p}</option>`);
  strutturaEl.innerHTML="<option value=''>SELEZIONARE</option>"; enteEl.innerHTML="<option value=''>SELEZIONARE</option>"; indirizzoEl.innerHTML="<option value=''>SELEZIONARE</option>";
}
function popolaStrutture(){const s=[...new Set(enti_strutture.filter(d=>d.Progetto===progettoEl.value).map(d=>d.Struttura))]; strutturaEl.innerHTML="<option value=''>SELEZIONARE</option>"; s.forEach(x=>strutturaEl.innerHTML+=`<option value="${x}">${x}</option>`); enteEl.innerHTML="<option value=''>SELEZIONARE</option>"; indirizzoEl.innerHTML="<option value=''>SELEZIONARE</option>";}
function popolaEnti(){const e=[...new Set(enti_strutture.filter(d=>d.Progetto===progettoEl.value&&d.Struttura===strutturaEl.value).map(d=>d.Ente))]; enteEl.innerHTML="<option value=''>SELEZIONARE</option>"; e.forEach(x=>enteEl.innerHTML+=`<option value="${x}">${x}</option>`); indirizzoEl.innerHTML="<option value=''>SELEZIONARE</option>";}
function popolaIndirizzi(){const i=enti_strutture.filter(d=>d.Progetto===progettoEl.value&&d.Struttura===strutturaEl.value&&d.Ente===enteEl.value).map(d=>d.Indirizzo); indirizzoEl.innerHTML="<option value=''>SELEZIONARE</option>"; i.forEach(x=>indirizzoEl.innerHTML+=`<option value="${x}">${x}</option>`);}

function aggiungiMateriale(){
  const div=document.createElement('div'); div.className='materiale-row';
  div.innerHTML=`<input type="text" placeholder="Descrizione materiale"><input type="number" step="0.01" placeholder="Prezzo €"><button type="button" class="btn secondary">X</button>`;
  div.querySelector('button').onclick=()=>{div.remove(); aggiornaRiepilogo();};
  materialiContainer.appendChild(div);
}

function aggiornaRiepilogo(){
  riepilogoBody.innerHTML=""; let subtotal=0, ivaTot=0;
  const operatori=Number(operatoriEl.value)||0, ore=Number(totOreEl.value)||0, mq=Number(mqEl.value)||0;

  if(manutenzioneChk.checked){const val=RATES.MANUTENZIONE*operatori*ore; subtotal+=val; ivaTot+=val*0.1; riepilogoBody.innerHTML+=`<tr><td>Manutenzione</td><td class="right">${val.toFixed(2)}</td></tr>`;}
  if(pulizieChk.checked){const val=RATES.PULIZIE*operatori*ore; subtotal+=val; /* esente IVA */ riepilogoBody.innerHTML+=`<tr><td>Pulizie</td><td class="right">${val.toFixed(2)}</td></tr>`;}
  if(sanificazioneChk.checked){const val=RATES.SANIFICAZIONE*mq; subtotal+=val; ivaTot+=val*0.22; riepilogoBody.innerHTML+=`<tr><td>Sanificazione</td><td class="right">${val.toFixed(2)}</td></tr>`;}
  if(disinfestazioneChk.checked){const val=RATES.DISINFESTAZIONE*mq; subtotal+=val; ivaTot+=val*0.22; riepilogoBody.innerHTML+=`<tr><td>Disinfestazione</td><td class="right">${val.toFixed(2)}</td></tr>`;}
  if(derattizzazioneChk.checked){const val=RATES.DERATTIZZAZIONE*mq; subtotal+=val; ivaTot+=val*0.22; riepilogoBody.innerHTML+=`<tr><td>Derattizzazione</td><td class="right">${val.toFixed(2)}</td></tr>`;}

  Array.from(materialiContainer.querySelectorAll('.materiale-row')).forEach(row=>{
    const desc=row.querySelector('input[type=text]').value, price=parseFloat(row.querySelector('input[type=number]').value)||0;
    if(desc&&price){subtotal+=price; ivaTot+=price*0.22; riepilogoBody.innerHTML+=`<tr><td>${desc}</td><td class="right">${price.toFixed(2)}</td></tr>`;}
  });

  subtotalEl.textContent=subtotal.toFixed(2);
  ivaEl.textContent=ivaTot.toFixed(2);
  totalEl.textContent=(subtotal+ivaTot).toFixed(2);
}

progettoEl.addEventListener('change',()=>{popolaStrutture(); aggiornaRiepilogo();});
strutturaEl.addEventListener('change',()=>{popolaEnti(); aggiornaRiepilogo();});
enteEl.addEventListener('change',()=>{popolaIndirizzi(); aggiornaRiepilogo();});
[indirizzoEl,operatoriEl,totOreEl,mqEl,manutenzioneChk,pulizieChk,sanificazioneChk,disinfestazioneChk,derattizzazioneChk].forEach(el=>el.addEventListener('input',aggiornaRiepilogo));
aggiungiMaterialeBtn.onclick=aggiungiMateriale;
[nomeOperatoreInput,nomeClienteInput].forEach(el=>el.addEventListener('input',()=>{
  nomeOperatoreStampa.textContent=nomeOperatoreInput.value;
  nomeClienteStampa.textContent=nomeClienteInput.value;
}));

document.getElementById('print').onclick=()=>window.print();
document.getElementById('exportJson').onclick=()=>{ const data=new FormData(document.getElementById('moduloForm')); const obj={}; for(const [k,v] of data.entries()) obj[k]=v; console.log(JSON.stringify(obj, null, 2)); alert("JSON stampato in console."); }

function abilitaFirma(canvasId, imgId){
  const canvas=document.getElementById(canvasId); const ctx=canvas.getContext('2d'); let disegnando=false;
  canvas.addEventListener('mousedown',e=>{ disegnando=true; ctx.beginPath(); ctx.moveTo(e.offsetX,e.offsetY); });
  canvas.addEventListener('mousemove',e=>{ if(disegnando){ ctx.lineTo(e.offsetX,e.offsetY); ctx.stroke(); } });
  canvas.addEventListener('mouseup',e=>{ if(disegnando){ ctx.stroke(); disegnando=false; aggiornaImg(canvasId,imgId); } });
  canvas.addEventListener('mouseleave',e=>{ if(disegnando){ ctx.stroke(); disegnando=false; aggiornaImg(canvasId,imgId); } });
}
function aggiornaImg(canvasId,imgId){ document.getElementById(imgId).src=document.getElementById(canvasId).toDataURL('image/png'); }
function pulisciFirma(id){ const canvas=document.getElementById(id); const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); aggiornaImg(id,id+'_stampa'); }

abilitaFirma('firmaOperatore','firmaOperatore_stampa');
abilitaFirma('firmaCliente','firmaCliente_stampa');

caricaEntiStrutture();
</script>
</body>
</html>
