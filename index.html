<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ordine di Servizio — Irpinia Logistica</title>
<style>
:root { --max-width:980px; --gap:12px; --accent:#0b67ff; }
body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
       background:#f5f7fb; color:#1f2937; padding:24px;
       display:flex; justify-content:center; flex-direction:column; align-items:center; }
.container { width:100%; max-width:var(--max-width); background:#fff; border-radius:12px;
            box-shadow:0 6px 24px rgba(20,30,60,0.08); padding:20px; }
h1 { font-size:20px; margin:0 0 8px; text-align:center; }
form { display:grid; grid-template-columns:1fr 320px; gap:18px; }
.panel { background:#fbfdff; border:1px solid #e6eefb; padding:12px; border-radius:8px; }
label { display:block; font-size:13px; font-weight:600; margin-bottom:6px; }
.field { margin-bottom:12px; }
select,input[type="text"],input[type="number"],textarea { width:100%; padding:8px; border:1px solid #d1d9e6; border-radius:6px; font-size:14px; box-sizing:border-box; }
textarea { min-height:80px; resize:vertical; }
.small { font-size:13px; color:#475569; }
.btn { background:var(--accent); color:#fff; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
.btn.secondary { background:#fff; color:var(--accent); border:1px solid #cfe0ff; }
.summary { background:#fff; padding:12px; border-radius:8px; border:1px solid #eef2ff; }
table { width:100%; border-collapse:collapse; }
td,th { padding:8px; text-align:left; border-bottom:1px solid #f1f5f9; }
td.right,th.right { text-align:right; }
.logo-container { text-align:center; margin-bottom:10px; }
.logo-container img { max-width:177px; max-height:118px; height:auto; }
.header-info { text-align:center; font-size:13px; line-height:1.2; margin-bottom:20px; }
.header-info .title { font-size:16px; font-weight:bold; margin-bottom:5px; }
.firme-container { display: flex; gap: 20px; justify-content: space-between; width: 100%; margin-top: 15px; flex-wrap: nowrap; }
.firma-canvas-container { flex: 1; max-width: 48%; position: relative; }
.firma-canvas { border:1px solid #000; cursor:crosshair; background-color:#fff; width:100%; height:150px; display:block; touch-action:none; }
.firma-stampa { display:none; border:1px solid #000; width:100%; height:150px; pointer-events:none; }
.materiale-row { display:flex; gap:6px; margin-bottom:6px; }
.materiale-row input[type=text]{ flex:2; } .materiale-row input[type=number]{ flex:1; }
@media(max-width:900px){
  form{grid-template-columns:1fr}
  .firma-canvas{max-width:100%;}
}
@media print{
  @page {size:A4 portrait;margin:15mm;}
  body {padding:0;background:#fff;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
  .container {width:100%; max-width:100%; box-shadow:none; border-radius:0; padding:0; display:block;}
  .btn,.firma-canvas-container button,.small.muted {display:none !important;}
  .firma-canvas { display: none !important; }
  .firma-canvas-container { display: flex; flex-direction: column; align-items: center; }
  .firma-canvas-container h3 { display: block !important; text-align:center; margin-bottom:5px; }
  .firma-stampa { display: block !important; width:150px; height:75px; margin-bottom:5px; }
}
</style>
</head>
<body>
<div class="container">
  <div class="logo-container"><img src="logo.jpg" alt="Logo Azienda"/></div>
  <div class="header-info">
    <div class="title">Sede Legale:</div>
    <div>Via Municipio, n. 14 - 83040 Fontanarosa (AV)</div>
    <div>Info – 082545553</div>
    <div>Mail - irpinialogistica@gmail.com</div>
    <div>PEC - irpinialogistica@pec.it</div>
    <div>C.F. / Partita IVA 03196380640</div>
  </div>
  <h1>ORDINE DI SERVIZIO</h1>
  <form id="moduloForm" autocomplete="off">
    <div>
      <div class="panel">
        <div class="field"><label for="progetto">Progetto</label><select id="progetto"></select></div>
        <div class="field"><label for="struttura">Struttura</label><select id="struttura"></select></div>
        <div class="field"><label for="ente">Ente</label><select id="ente"></select></div>
        <div class="field"><label for="indirizzo">Indirizzo</label><select id="indirizzo"></select></div>
        <div class="field"><label for="descrizione">Descrizione dei lavori</label><textarea id="descrizione" placeholder="Descrivi il lavoro svolto..."></textarea></div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
          <div class="field"><label for="dataLavoro">Data lavoro</label><input id="dataLavoro" type="date"/></div>
          <div class="field"><label for="oraInizio">Ora inizio</label><input id="oraInizio" type="time"/></div>
          <div class="field"><label for="oraFine">Ora fine</label><input id="oraFine" type="time"/></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
          <div class="field"><label for="operatori">Numero operatori</label><input id="operatori" type="number" min="0" step="1" value="1"/></div>
          <div class="field"><label for="totOre">Totale ore</label><input id="totOre" type="number" min="0" step="0.5" value="0"/></div>
          <div class="field"><label for="mq">Metri quadrati (mq)</label><input id="mq" type="number" min="0" step="0.1" value="0"/></div>
        </div>
        <div class="field">
          <label>Tipologia lavoro</label>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <label><input type="checkbox" id="manutenzione_chk"/> Manutenzione</label>
            <label><input type="checkbox" id="pulizie_chk"/> Pulizie</label>
            <label><input type="checkbox" id="sanificazione_chk"/> Sanificazione</label>
            <label><input type="checkbox" id="disinfestazione_chk"/> Disinfestazione</label>
            <label><input type="checkbox" id="derattizzazione_chk"/> Derattizzazione</label>
          </div>
        </div>
        <div class="field">
          <label>Materiali forniti</label>
          <div id="materiali-container"></div>
          <button type="button" class="btn secondary" id="aggiungiMaterialeBtn">Aggiungi materiale</button>
        </div>
        <p class="small">
          COSTI DEL PERSONALE E DEI SERVIZI SVOLTI DA IRPINIA LOGISTICA SOCIETA’ COOP.SOC. ETS<br>
          - Il costo della manutenzione è di 25,00€ l’ora per singolo operatore<br>
          - Il costo del servizio di pulizia è di 20.00€ l’ora per singolo operatore<br>
          - Il costo della sanificazione a metro quadro è di 2.00€<br>
          - Il costo della disinfestazione a metro quadro è di 4.50€<br>
          - Il costo della derattizzazione a metro quadro è di 6.50€
        </p>
      </div>
    </div>
    <aside class="panel">
      <h3>Riepilogo costi</h3>
      <div class="summary">
        <table><tbody id="riepilogoBody"></tbody></table>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <span>Subtotale € <span id="subtotal">0.00</span></span> | 
          <span>IVA € <span id="iva">0.00</span></span> | 
          <span>Totale € <span id="total">0.00</span></span>
        </div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end;">
        <button type="button" class="btn" id="print">Stampa / Salva PDF</button>
        <button type="button" class="btn secondary" id="exportJson">Esporta (JSON)</button>
      </div>
    </aside>
    <div class="firme-container">
      <div class="firma-canvas-container">
        <h3>Firma operatore</h3>
        <canvas id="firmaOperatore" class="firma-canvas"></canvas>
        <img id="firmaOperatore_stampa" class="firma-stampa" />
        <input type="text" id="nomeOperatore" placeholder="Nome Operatore" style="margin-top:6px;width:100%;padding:6px;border:1px solid #d1d9e6;border-radius:6px;">
        <button type="button" class="btn secondary" onclick="pulisciFirma('firmaOperatore')">Pulisci firma</button>
      </div>
      <div class="firma-canvas-container">
        <h3>Firma cliente</h3>
        <canvas id="firmaCliente" class="firma-canvas"></canvas>
        <img id="firmaCliente_stampa" class="firma-stampa" />
        <input type="text" id="nomeCliente" placeholder="Nome Cliente" style="margin-top:6px;width:100%;padding:6px;border:1px solid #d1d9e6;border-radius:6px;">
        <button type="button" class="btn secondary" onclick="pulisciFirma('firmaCliente')">Pulisci firma</button>
      </div>
    </div>
  </form>
</div>

<script>
// ================= JSON =================
let enti_strutture = [];
async function caricaEntiStrutture() {
  try {
    const response = await fetch('enti_strutture.json');
    if(!response.ok) throw new Error("Errore caricamento JSON");
    enti_strutture = await response.json();
    popolaProgetti();
  } catch(e){console.error(e); alert("Impossibile caricare enti_strutture.json");}
}

// ================= Select cascading =================
const progettoEl=document.getElementById('progetto');
const strutturaEl=document.getElementById('struttura');
const enteEl=document.getElementById('ente');
const indirizzoEl=document.getElementById('indirizzo');

function popolaProgetti(){
  const progetti=[...new Set(enti_strutture.map(d=>d.Progetto))];
  progettoEl.innerHTML="<option value=''>SELEZIONARE</option>";
  progetti.forEach(p=>progettoEl.innerHTML+=`<option value="${p}">${p}</option>`);
  strutturaEl.innerHTML="<option value=''>SELEZIONARE</option>";
  enteEl.innerHTML="<option value=''>SELEZIONARE</option>";
  indirizzoEl.innerHTML="<option value=''>SELEZIONARE</option>";
}

function popolaStrutture(){
  const strutture=[...new Set(enti_strutture.filter(d=>d.Progetto===progettoEl.value).map(d=>d.Struttura))];
  strutturaEl.innerHTML="<option value=''>SELEZIONARE</option>";
  strutture.forEach(s=>strutturaEl.innerHTML+=`<option value="${s}">${s}</option>`);
  enteEl.innerHTML="<option value=''>SELEZIONARE</option>";
  indirizzoEl.innerHTML="<option value=''>SELEZIONARE</option>";
}

function popolaEnti(){
  const enti=[...new Set(enti_strutture.filter(d=>d.Progetto===progettoEl.value && d.Struttura===strutturaEl.value).map(d=>d.Ente))];
  enteEl.innerHTML="<option value=''>SELEZIONARE</option>";
  enti.forEach(e=>enteEl.innerHTML+=`<option value="${e}">${e}</option>`);
  indirizzoEl.innerHTML="<option value=''>SELEZIONARE</option>";
}

function popolaIndirizzi(){
  const indirizzi=[...new Set(enti_strutture.filter(d=>d.Progetto===progettoEl.value && d.Struttura===strutturaEl.value && d.Ente===enteEl.value).map(d=>d.Indirizzo))];
  indirizzoEl.innerHTML="<option value=''>SELEZIONARE</option>";
  indirizzi.forEach(i=>indirizzoEl.innerHTML+=`<option value="${i}">${i}</option>`);
}

progettoEl.addEventListener('change',()=>{popolaStrutture(); aggiornaRiepilogo();});
strutturaEl.addEventListener('change',()=>{popolaEnti(); aggiornaRiepilogo();});
enteEl.addEventListener('change',()=>{popolaIndirizzi(); aggiornaRiepilogo();});
indirizzoEl.addEventListener('change',aggiornaRiepilogo);

// ================= Materiali =================
const materialiContainer=document.getElementById('materiali-container');
const aggiungiMaterialeBtn=document.getElementById('aggiungiMaterialeBtn');
aggiungiMaterialeBtn.addEventListener('click',()=>{
  const div=document.createElement('div'); div.className='materiale-row';
  div.innerHTML=`<input type="text" placeholder="Descrizione materiale"><input type="number" step="0.01" placeholder="Prezzo €"><button type="button" class="btn secondary">X</button>`;
  div.querySelector('button').onclick=()=>{div.remove(); aggiornaRiepilogo();};
  materialiContainer.appendChild(div);
});

// ================= Riepilogo =================
const operatoriEl=document.getElementById('operatori'), totOreEl=document.getElementById('totOre'), mqEl=document.getElementById('mq');
const manutenzioneChk=document.getElementById('manutenzione_chk'), pulizieChk=document.getElementById('pulizie_chk'), sanificazioneChk=document.getElementById('sanificazione_chk'), disinfestazioneChk=document.getElementById('disinfestazione_chk'), derattizzazioneChk=document.getElementById('derattizzazione_chk');
const subtotalEl=document.getElementById('subtotal'), ivaEl=document.getElementById('iva'), totalEl=document.getElementById('total'), riepilogoBody=document.getElementById('riepilogoBody');

function aggiornaRiepilogo(){
  riepilogoBody.innerHTML=""; let subtotal=0; let iva=0;
  const operatori=Number(operatoriEl.value)||0, ore=Number(totOreEl.value)||0, mq=Number(mqEl.value)||0;
  if(manutenzioneChk.checked){const val=25*operatori*ore; subtotal+=val; iva+=0.1*val; riepilogoBody.innerHTML+=`<tr><td>Manutenzione</td><td class="right">${val.toFixed(2)}</td></tr>`;}
  if(pulizieChk.checked){const val=20*operatori*ore; subtotal+=val; /* IVA 0 */ riepilogoBody.innerHTML+=`<tr><td>Pulizie</td><td class="right">${val.toFixed(2)}</td></tr>`;}
  if(sanificazioneChk.checked){const val=2*mq; subtotal+=val; iva+=0.22*val; riepilogoBody.innerHTML+=`<tr><td>Sanificazione</td><td class="right">${val.toFixed(2)}</td></tr>`;}
  if(disinfestazioneChk.checked){const val=4.5*mq; subtotal+=val; iva+=0.22*val; riepilogoBody.innerHTML+=`<tr><td>Disinfestazione</td><td class="right">${val.toFixed(2)}</td></tr>`;}
  if(derattizzazioneChk.checked){const val=6.5*mq; subtotal+=val; iva+=0.22*val; riepilogoBody.innerHTML+=`<tr><td>Derattizzazione</td><td class="right">${val.toFixed(2)}</td></tr>`;}
  Array.from(materialiContainer.querySelectorAll('div.materiale-row')).forEach(row=>{
    const prezzo=Number(row.querySelector('input[type=number]').value)||0;
    const desc=row.querySelector('input[type=text]').value||'Materiale';
    subtotal+=prezzo; iva+=0.22*prezzo;
    riepilogoBody.innerHTML+=`<tr><td>${desc}</td><td class="right">${prezzo.toFixed(2)}</td></tr>`;
  });
  subtotalEl.textContent=subtotal.toFixed(2);
  ivaEl.textContent=iva.toFixed(2);
  totalEl.textContent=(subtotal+iva).toFixed(2);
}

[operatoriEl, totOreEl, mqEl, manutenzioneChk, pulizieChk, sanificazioneChk, disinfestazioneChk, derattizzazioneChk].forEach(el=>el.addEventListener('input', aggiornaRiepilogo));
materialiContainer.addEventListener('input', aggiornaRiepilogo);

// ================= Firme =================
function inizializzaFirma(idCanvas,idImg){
  const canvas = document.getElementById(idCanvas);
  const ctx = canvas.getContext('2d');
  let disegno = false;

  function ridimensiona() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';
  }
  ridimensiona();
  window.addEventListener('resize', () => { if (!disegno) ridimensiona(); });

  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : null;
    const clientX = touch ? touch.clientX : e.clientX;
    const clientY = touch ? touch.clientY : e.clientY;
    return {x: clientX - rect.left, y: clientY - rect.top};
  }

  function inizio(e){ e.preventDefault(); disegno=true; ctx.beginPath(); const pos=getPos(e); ctx.moveTo(pos.x,pos.y); }
  function muovi(e){ e.preventDefault(); if(!disegno) return; const pos=getPos(e); ctx.lineTo(pos.x,pos.y); ctx.stroke(); }
  function fine(){ disegno=false; }

  canvas.addEventListener('mousedown',inizio);
  canvas.addEventListener('mousemove',muovi);
  canvas.addEventListener('mouseup',fine);
  canvas.addEventListener('touchstart',inizio);
  canvas.addEventListener('touchmove',muovi);
  canvas.addEventListener('touchend',fine);

  window[idCanvas+'_aggiornaImg'] = () => {
    document.getElementById(idImg).src = canvas.toDataURL();
  };
}
function pulisciFirma(idCanvas){
  const canvas = document.getElementById(idCanvas);
  canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height);
  window[idCanvas+'_aggiornaImg']();
}
inizializzaFirma('firmaOperatore','firmaOperatore_stampa');
inizializzaFirma('firmaCliente','firmaCliente_stampa');

// ================= Stampa =================
document.getElementById('print').addEventListener('click',()=>{
  window.firmaOperatore_aggiornaImg(); window.firmaCliente_aggiornaImg(); window.print();
});

// ================= JSON export =================
document.getElementById('exportJson').addEventListener('click',()=>{
  const dati={progetto:progettoEl.value,struttura:strutturaEl.value,ente:enteEl.value,indirizzo:indirizzoEl.value,descrizione:document.getElementById('descrizione').value,data:document.getElementById('dataLavoro').value,oraInizio:document.getElementById('oraInizio').value,oraFine:document.getElementById('oraFine').value,operatori:operatoriEl.value,totOre:totOreEl.value,mq:mqEl.value,tipoLavoro:{manutenzione:manutenzioneChk.checked,pulizie:pulizieChk.checked,sanificazione:sanificazioneChk.checked,disinfestazione:disinfestazioneChk.checked,derattizzazione:derattizzazioneChk.checked},materiali:Array.from(materialiContainer.querySelectorAll('div.materiale-row')).map(r=>({descrizione:r.querySelector('input[type=text]').value,prezzo:r.querySelector('input[type=number]').value})),nomeOperatore:document.getElementById('nomeOperatore').value,nomeCliente:document.getElementById('nomeCliente').value,firmaOperatore:document.getElementById('firmaOperatore_stampa').src,firmaCliente:document.getElementById('firmaCliente_stampa').src};
  const blob=new Blob([JSON.stringify(dati,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download="ordine_servizio.json"; a.click(); URL.revokeObjectURL(url);
});
// ================= Calcolo automatico ore =================
function calcolaOreAutomatico() {
  const inizio = document.getElementById('oraInizio').value;
  const fine = document.getElementById('oraFine').value;

  if (inizio && fine) {
    const [h1, m1] = inizio.split(':').map(Number);
    const [h2, m2] = fine.split(':').map(Number);

    // Converto tutto in minuti
    const minutiInizio = h1 * 60 + m1;
    const minutiFine = h2 * 60 + m2;

    let diff = (minutiFine - minutiInizio) / 60; // in ore

    if (diff < 0) diff = 0; // Evito valori negativi

    document.getElementById('totOre').value = diff.toFixed(2);
    aggiornaRiepilogo();
  }
}

// Aggiorno ore ogni volta che cambia ora inizio/fine
document.getElementById('oraInizio').addEventListener('change', calcolaOreAutomatico);
document.getElementById('oraFine').addEventListener('change', calcolaOreAutomatico);

// ================= Init =================
caricaEntiStrutture();
</script>
</body>
</html>
