<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Modulo Ordine di Servizio</title>
<style>
:root{--max-width:980px;--accent:#0b67ff;}
body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:#f5f7fb;color:#1f2937;padding:24px;display:flex;justify-content:center;flex-direction:column;align-items:center;}
.container{width:100%;max-width:var(--max-width);background:#fff;border-radius:12px;box-shadow:0 6px 24px rgba(20,30,60,.08);padding:20px;}
h1{text-align:center;margin-bottom:20px;}
.panel{background:#fbfdff;border:1px solid #e6eefb;padding:12px;border-radius:8px;margin-bottom:12px;}
label{display:block;font-weight:600;margin-bottom:6px;font-size:13px;}
.field{margin-bottom:12px;}
input,textarea,select{width:100%;padding:8px;border:1px solid #d1d9e6;border-radius:6px;font-size:14px;box-sizing:border-box;}
textarea{min-height:80px;resize:vertical;}
.btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;}
.btn.secondary{background:#fff;color:var(--accent);border:1px solid #cfe0ff;}
.summary{background:#fff;padding:12px;border-radius:8px;border:1px solid #eef2ff;}
table{width:100%;border-collapse:collapse;margin-top:6px;}
td,th{padding:8px;text-align:left;border-bottom:1px solid #f1f5f9;}
.right{text-align:right;}
.muted{color:#6b7280;font-size:13px;}
.firme-container{display:flex;gap:20px;margin-top:15px;flex-wrap:wrap;}
.firma-canvas{border:1px solid #000;width:100%;max-width:300px;height:150px;cursor:crosshair;background:#fff;}
.materiale-row{display:flex;gap:8px;margin-bottom:6px;}
.materiale-row input[type="text"]{flex:2;}
.materiale-row input[type="number"]{width:100px;}
</style>
</head>
<body>
<div class="container">
  <h1>ORDINE DI SERVIZIO</h1>
  <form id="moduloForm" autocomplete="off" onsubmit="return false;">

    <!-- Progetto / Struttura / Ente / Indirizzo -->
    <div class="panel">
      <div class="field">
        <label for="progetto">Progetto</label>
        <select id="progetto"></select>
      </div>
      <div class="field">
        <label for="struttura">Struttura</label>
        <select id="struttura"></select>
      </div>
      <div class="field">
        <label for="ente">Ente</label>
        <select id="ente"></select>
      </div>
      <div class="field">
        <label for="indirizzo">Indirizzo</label>
        <select id="indirizzo"></select>
        <span id="indirizzo-stampa" style="display:none;"></span>
      </div>
    </div>

    <!-- Descrizione lavori -->
    <div class="panel">
      <div class="field">
        <label for="descrizione">Descrizione dei lavori</label>
        <textarea id="descrizione" name="DESCRIZIONE" placeholder="Descrivi il lavoro svolto..."></textarea>
      </div>

      <!-- Materiali dinamici -->
      <div class="field">
        <label>Materiale fornito</label>
        <div id="materiali-container"></div>
        <button type="button" class="btn secondary" id="aggiungi-materiale">+ Aggiungi materiale</button>
        <div class="small muted">Inserisci descrizione e prezzo del materiale fornito. I costi si sommano al riepilogo.</div>
      </div>

      <!-- Operatori, ore e metri quadrati -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="field">
          <label for="operatori">Numero operatori</label>
          <input id="operatori" type="number" min="0" step="1" value="1">
        </div>
        <div class="field">
          <label for="totOre">Totale ore</label>
          <input id="totOre" type="number" min="0" step="0.5" value="0">
        </div>
      </div>
      <div class="field">
        <label for="mq">Metri quadrati (mq)</label>
        <input id="mq" type="number" min="0" step="0.1" value="0">
      </div>

      <!-- Tipologia lavoro -->
      <div class="field">
        <label>Tipologia lavoro</label>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <label><input type="checkbox" id="manutenzione_chk"> Manutenzione</label>
          <label><input type="checkbox" id="pulizie_chk"> Pulizie</label>
          <label><input type="checkbox" id="sanificazione_chk"> Sanificazione</label>
          <label><input type="checkbox" id="disinfestazione_chk"> Disinfestazione</label>
          <label><input type="checkbox" id="derattizzazione_chk"> Derattizzazione</label>
        </div>
        <!-- Riepilogo costi per tipologia -->
        <div class="small muted" style="margin-top:6px; white-space:pre-line;">
          Riferimento costi:
          Manutenzione (€/ora per operatore)  € 25.00
          Pulizie (€/ora per operatore)        € 20.00
          Sanificazione (€/mq)                € 2.00
          Disinfestazione (€/mq)              € 4.50
          Derattizzazione (€/mq)              € 6.50
        </div>
      </div>
    </div>

    <!-- Riepilogo costi -->
    <div class="panel summary">
      <h3>Riepilogo costi</h3>
      <div id="costiSelezionati"></div>
      <table>
        <tbody>
          <tr><th>Subtotale</th><th class="right">€ <span id="subtotal">0.00</span></th></tr>
          <tr><td>IVA (22%)</td><td class="right">€ <span id="iva">0.00</span></td></tr>
          <tr><th>Totale</th><th class="right">€ <span id="total">0.00</span></th></tr>
        </tbody>
      </table>
    </div>

    <!-- Firme -->
    <div class="firme-container">
      <div>
        <label>Firma operatore</label>
        <canvas id="firmaOperatore" class="firma-canvas"></canvas>
      </div>
      <div>
        <label>Firma cliente</label>
        <canvas id="firmaCliente" class="firma-canvas"></canvas>
      </div>
    </div>

    <!-- Bottoni -->
    <div style="margin-top:12px;display:flex;gap:8px;">
      <button type="button" class="btn" id="print">Stampa</button>
      <button type="button" class="btn secondary" id="exportJson">Esporta JSON</button>
    </div>
  </form>
</div>

<script>
// ================= Dati =================
const datiIndirizzi=[
  {Progetto:"SAI-A01",Struttura:"AVELLINO",Ente:"PERCORSI",Indirizzo:"Via Roma 10, Avellino"},
  {Progetto:"SAI-A01",Struttura:"AVELLINO",Ente:"AIC",Indirizzo:"Via Torino 5, Avellino"},
  {Progetto:"SAI-A02",Struttura:"BENEVENTO",Ente:"PERCORSI",Indirizzo:"Corso Garibaldi 25, Benevento"}
];
const RATES={MANUTENZIONE:25,PULIZIE:20,SANIFICAZIONE:2,DISINFESTAZIONE:4.5,DERATTIZZAZIONE:6.5};

// ================= Elementi =================
const progettoEl=document.getElementById('progetto');
const strutturaEl=document.getElementById('struttura');
const enteEl=document.getElementById('ente');
const indirizzoEl=document.getElementById('indirizzo');
const operatoriEl=document.getElementById('operatori');
const totOreEl=document.getElementById('totOre');
const mqEl=document.getElementById('mq');
const manutenzioneChk=document.getElementById('manutenzione_chk');
const pulizieChk=document.getElementById('pulizie_chk');
const sanificazioneChk=document.getElementById('sanificazione_chk');
const disinfestazioneChk=document.getElementById('disinfestazione_chk');
const derattizzazioneChk=document.getElementById('derattizzazione_chk');
const subtotalEl=document.getElementById('subtotal');
const ivaEl=document.getElementById('iva');
const totalEl=document.getElementById('total');
const costiSelezionatiEl=document.getElementById('costiSelezionati');
const materialiContainer=document.getElementById('materiali-container');
const aggiungiMaterialeBtn=document.getElementById('aggiungi-materiale');

// ================= Popola Progetti / Strutture / Enti / Indirizzi =================
function popolaProgetti(){
  const progetti=[...new Set(datiIndirizzi.map(d=>d.Progetto))];
  progettoEl.innerHTML="<option value=''>SELEZIONARE</option>";
  progetti.forEach(p=>progettoEl.innerHTML+=`<option value="${p}">${p}</option>`);
}
function popolaStrutture(){
  const val=progettoEl.value;
  const strutture=[...new Set(datiIndirizzi.filter(d=>d.Progetto===val).map(d=>d.Struttura))];
  strutturaEl.innerHTML="<option value=''>SELEZIONARE</option>";
  strutture.forEach(s=>strutturaEl.innerHTML+=`<option value="${s}">${s}</option>`);
  enteEl.innerHTML="<option value=''>SELEZIONARE</option>";
  indirizzoEl.innerHTML="";
}
function popolaEnti(){
  const valProgetto=progettoEl.value;
  const valStruttura=strutturaEl.value;
  const enti=[...new Set(datiIndirizzi.filter(d=>d.Progetto===valProgetto && d.Struttura===valStruttura).map(d=>d.Ente))];
  enteEl.innerHTML="<option value=''>SELEZIONARE</option>";
  enti.forEach(e=>enteEl.innerHTML+=`<option value="${e}">${e}</option>`);
  indirizzoEl.innerHTML="";
}
function popolaIndirizzi(){
  const valProgetto=progettoEl.value;
  const valStruttura=strutturaEl.value;
  const valEnte=enteEl.value;
  const indirizzi=datiIndirizzi.filter(d=>d.Progetto===valProgetto && d.Struttura===valStruttura && d.Ente===valEnte);
  indirizzoEl.innerHTML="";
  indirizzi.forEach(i=>indirizzoEl.innerHTML+=`<option value="${i.Indirizzo}">${i.Indirizzo}</option>`);
}

// ================= Eventi =================
progettoEl.addEventListener('change',()=>{popolaStrutture(); calcolaTotale();});
strutturaEl.addEventListener('change',()=>{popolaEnti(); calcolaTotale();});
enteEl.addEventListener('change',()=>{popolaIndirizzi(); calcolaTotale();});
operatoriEl.addEventListener('input',calcolaTotale);
totOreEl.addEventListener('input',calcolaTotale);
mqEl.addEventListener('input',calcolaTotale);
[manutenzioneChk,pulizieChk,sanificazioneChk,disinfestazioneChk,derattizzazioneChk].forEach(chk=>chk.addEventListener('change',calcolaTotale));

// ================= Materiali =================
function aggiungiMateriale(){
  const div=document.createElement('div');
  div.className='materiale-row';
  div.innerHTML=`
    <input type="text" placeholder="Descrizione">
    <input type="number" placeholder="€" value="0" min="0" step="0.01">
    <button type="button" class="btn secondary">X</button>
  `;
  const btn=div.querySelector('button');
  btn.addEventListener('click',()=>{div.remove(); calcolaTotale();});
  div.querySelectorAll('input').forEach(inp=>inp.addEventListener('input',calcolaTotale));
  materialiContainer.appendChild(div);
}
aggiungiMaterialeBtn.addEventListener('click',aggiungiMateriale);

// ================= Calcolo =================
function calcolaTotale(){
  let subtotal=0;
  // Tipologia lavoro
  if(manutenzioneChk.checked) subtotal+=RATES.MANUTENZIONE*operatoriEl.value*totOreEl.value;
  if(pulizieChk.checked) subtotal+=RATES.PULIZIE*operatoriEl.value*totOreEl.value;
  if(sanificazioneChk.checked) subtotal+=RATES.SANIFICAZIONE*mqEl.value;
  if(disinfestazioneChk.checked) subtotal+=RATES.DISINFESTAZIONE*mqEl.value;
  if(derattizzazioneChk.checked) subtotal+=RATES.DERATTIZZAZIONE*mqEl.value;
  // Materiali
  const materialiPrezzi=[...materialiContainer.querySelectorAll('input[type=number]')].map(i=>parseFloat(i.value)||0);
  subtotal+=materialiPrezzi.reduce((a,b)=>a+b,0);
  const iva=subtotal*0.22;
  const total=subtotal+iva;
  subtotalEl.textContent=subtotal.toFixed(2);
  ivaEl.textContent=iva.toFixed(2);
  totalEl.textContent=total.toFixed(2);

  // Riepilogo selezioni
  let riassunto='';
  if(manutenzioneChk.checked) riassunto+='Manutenzione € '+(RATES.MANUTENZIONE*operatoriEl.value*totOreEl.value).toFixed(2)+'\n';
  if(pulizieChk.checked) riassunto+='Pulizie € '+(RATES.PULIZIE*operatoriEl.value*totOreEl.value).toFixed(2)+'\n';
  if(sanificazioneChk.checked) riassunto+='Sanificazione € '+(RATES.SANIFICAZIONE*mqEl.value).toFixed(2)+'\n';
  if(disinfestazioneChk.checked) riassunto+='Disinfestazione € '+(RATES.DISINFESTAZIONE*mqEl.value).toFixed(2)+'\n';
  if(derattizzazioneChk.checked) riassunto+='Derattizzazione € '+(RATES.DERATTIZZAZIONE*mqEl.value).toFixed(2)+'\n';
  materialiContainer.querySelectorAll('.materiale-row').forEach((row,i)=>{
    const desc=row.querySelector('input[type=text]').value;
    const prezzo=parseFloat(row.querySelector('input[type=number]').value)||0;
    if(desc) riassunto+=desc+' € '+prezzo.toFixed(2)+'\n';
  });
  costiSelezionatiEl.textContent=riassunto;
}

// ================= Popola iniziale =================
popolaProgetti();
calcolaTotale();

// ================= Stampa / JSON =================
document.getElementById('print').addEventListener('click',()=>{window.print();});
document.getElementById('exportJson').addEventListener('click',()=>{
  const data={
    progetto:progettoEl.value,
    struttura:strutturaEl.value,
    ente:enteEl.value,
    indirizzo:indirizzoEl.value,
    descrizione:document.getElementById('descrizione').value,
    materiali:[...materialiContainer.querySelectorAll('.materiale-row')].map(r=>{
      return {desc:r.querySelector('input[type=text]').value, prezzo:parseFloat(r.querySelector('input[type=number]').value)||0};
    }),
    operatori:operatoriEl.value,
    ore:totOreEl.value,
    mq:mqEl.value,
    tipologia:{
      manutenzione:manutenzioneChk.checked,
      pulizie:pulizieChk.checked,
      sanificazione:sanificazioneChk.checked,
      disinfestazione:disinfestazioneChk.checked,
      derattizzazione:derattizzazioneChk.checked
    },
    subtotal:parseFloat(subtotalEl.textContent),
    iva:parseFloat(ivaEl.textContent),
    total:parseFloat(totalEl.textContent)
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='ordine_servizio.json'; a.click(); URL.revokeObjectURL(url);
});
</script>
</body>
</html>
