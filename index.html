<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Modulo Ordine di Servizio</title>
<style>
:root{--max-width:980px;--accent:#0b67ff;}
body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:#f5f7fb;color:#1f2937;padding:24px;display:flex;justify-content:center;flex-direction:column;align-items:center;}
.container{width:100%;max-width:var(--max-width);background:#fff;border-radius:12px;box-shadow:0 6px 24px rgba(20,30,60,.08);padding:20px;}
.logo-container{text-align:center;margin-bottom:15px;}
.logo-container img{max-width:177px;height:auto;}
h1{text-align:center;margin-bottom:20px;}
.panel{background:#fbfdff;border:1px solid #e6eefb;padding:12px;border-radius:8px;margin-bottom:12px;}
label{display:block;font-weight:600;margin-bottom:6px;font-size:13px;}
.field{margin-bottom:12px;}
input,textarea,select{width:100%;padding:8px;border:1px solid #d1d9e6;border-radius:6px;font-size:14px;box-sizing:border-box;}
textarea{min-height:80px;resize:vertical;}
.btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;}
.btn.secondary{background:#fff;color:var(--accent);border:1px solid #cfe0ff;}
.summary{background:#fff;padding:12px;border-radius:8px;border:1px solid #eef2ff;}
table{width:100%;border-collapse:collapse;margin-top:6px;}
td,th{padding:8px;text-align:left;border-bottom:1px solid #f1f5f9;}
.right{text-align:right;}
.muted{color:#6b7280;font-size:13px;}
.firme-container{display:flex;gap:20px;margin-top:15px;flex-wrap:wrap;}
.firma-canvas{border:1px solid #000;width:100%;max-width:300px;height:150px;cursor:crosshair;background:#fff;}
.materiale-row{display:flex;gap:8px;margin-bottom:6px;}
.materiale-row input[type="text"]{flex:2;}
.materiale-row input[type="number"]{width:100px;}
</style>
</head>
<body>
<div class="container">
  <div class="logo-container">
    <img src="logo.jpg" alt="Logo Azienda">
  </div>
  <h1>ORDINE DI SERVIZIO</h1>
  <form id="moduloForm" autocomplete="off" onsubmit="return false;">
    <div class="panel">
      <div class="field"><label>Progetto</label><select id="progetto"></select></div>
      <div class="field"><label>Struttura</label><select id="struttura"></select></div>
      <div class="field"><label>Ente</label><select id="ente"></select></div>
      <div class="field"><label>Indirizzo</label><select id="indirizzo"></select></div>
    </div>

    <div class="panel">
      <div class="field"><label>Descrizione dei lavori</label><textarea id="descrizione"></textarea></div>

      <div class="field">
        <label>Materiale fornito</label>
        <div id="materiali-container"></div>
        <button type="button" class="btn secondary" id="aggiungi-materiale">+ Aggiungi materiale</button>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="field"><label>Numero operatori</label><input id="operatori" type="number" min="0" step="1" value="1"></div>
        <div class="field"><label>Totale ore</label><input id="totOre" type="number" min="0" step="0.5" value="0"></div>
      </div>
      <div class="field"><label>Metri quadrati (mq)</label><input id="mq" type="number" min="0" step="0.1" value="0"></div>

      <div class="field">
        <label>Tipologia lavoro</label>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <label><input type="checkbox" id="manutenzione_chk"> Manutenzione</label>
          <label><input type="checkbox" id="pulizie_chk"> Pulizie</label>
          <label><input type="checkbox" id="sanificazione_chk"> Sanificazione</label>
          <label><input type="checkbox" id="disinfestazione_chk"> Disinfestazione</label>
          <label><input type="checkbox" id="derattizzazione_chk"> Derattizzazione</label>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:12px;">
        <div class="field">
          <label for="dataLavoro">Data lavoro</label>
          <input type="date" id="dataLavoro" name="DATA_LAVORO">
        </div>
        <div class="field">
          <label for="oraInizio">Ora inizio</label>
          <input type="time" id="oraInizio" name="ORA_INIZIO">
        </div>
        <div class="field">
          <label for="oraFine">Ora fine</label>
          <input type="time" id="oraFine" name="ORA_FINE">
        </div>
      </div>

    </div>

    <div class="panel summary">
      <h3>Riepilogo costi</h3>
      <table id="riepilogo-costi">
        <thead><tr><th>Voce</th><th class="right">€</th></tr></thead>
        <tbody></tbody>
        <tfoot>
          <tr><th>Subtotale</th><th class="right" id="subtotal">0.00</th></tr>
          <tr><td>IVA (22%)</td><td class="right" id="iva">0.00</td></tr>
          <tr><th>Totale</th><th class="right" id="total">0.00</th></tr>
        </tfoot>
      </table>
    </div>

    <div class="firme-container">
      <div>
        <label>Firma operatore</label>
        <canvas id="firmaOperatore" class="firma-canvas"></canvas>
        <button type="button" class="btn secondary" onclick="pulisciFirma('firmaOperatore')">Pulisci</button>
      </div>
      <div>
        <label>Firma cliente</label>
        <canvas id="firmaCliente" class="firma-canvas"></canvas>
        <button type="button" class="btn secondary" onclick="pulisciFirma('firmaCliente')">Pulisci</button>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;">
      <button type="button" class="btn" id="print">Stampa</button>
      <button type="button" class="btn secondary" id="exportJson">Esporta JSON</button>
    </div>
  </form>
</div>

<script>
let datiIndirizzi=[];
const RATES={MANUTENZIONE:25,PULIZIE:20,SANIFICAZIONE:2,DISINFESTAZIONE:4.5,DERATTIZZAZIONE:6.5};
const progettoEl=document.getElementById('progetto');
const strutturaEl=document.getElementById('struttura');
const enteEl=document.getElementById('ente');
const indirizzoEl=document.getElementById('indirizzo');
const operatoriEl=document.getElementById('operatori');
const totOreEl=document.getElementById('totOre');
const mqEl=document.getElementById('mq');
const manutenzioneChk=document.getElementById('manutenzione_chk');
const pulizieChk=document.getElementById('pulizie_chk');
const sanificazioneChk=document.getElementById('sanificazione_chk');
const disinfestazioneChk=document.getElementById('disinfestazione_chk');
const derattizzazioneChk=document.getElementById('derattizzazione_chk');
const subtotalEl=document.getElementById('subtotal');
const ivaEl=document.getElementById('iva');
const totalEl=document.getElementById('total');
const riepilogoBody=document.querySelector('#riepilogo-costi tbody');
const materialiContainer=document.getElementById('materiali-container');
const aggiungiMaterialeBtn=document.getElementById('aggiungi-materiale');

// ================= Caricamento JSON =================
fetch('enti_strutture.json')
  .then(res=>res.json())
  .then(json=>{ datiIndirizzi=json; popolaProgetti(); })
  .catch(err=>console.error('Errore caricamento JSON',err));

// ================= Popolamento =================
function popolaProgetti(){
  const progetti=[...new Set(datiIndirizzi.map(d=>d.Progetto))];
  progettoEl.innerHTML="<option value=''>SELEZIONARE</option>";
  progetti.forEach(p=>progettoEl.innerHTML+=`<option value="${p}">${p}</option>`);
}
function popolaStrutture(){
  const val=progettoEl.value;
  const strutture=[...new Set(datiIndirizzi.filter(d=>d.Progetto===val).map(d=>d.Struttura))];
  strutturaEl.innerHTML="<option value=''>SELEZIONARE</option>";
  strutture.forEach(s=>strutturaEl.innerHTML+=`<option value="${s}">${s}</option>`);
  enteEl.innerHTML="<option value=''>SELEZIONARE</option>"; indirizzoEl.innerHTML="";
}
function popolaEnti(){
  const valPro=progettoEl.value, valStr=strutturaEl.value;
  const enti=[...new Set(datiIndirizzi.filter(d=>d.Progetto===valPro && d.Struttura===valStr).map(d=>d.Ente))];
  enteEl.innerHTML="<option value=''>SELEZIONARE</option>";
  enti.forEach(e=>enteEl.innerHTML+=`<option value="${e}">${e}</option>`); indirizzoEl.innerHTML="";
}
function popolaIndirizzi(){
   const valPro=progettoEl.value, valStr=strutturaEl.value, valEn=enteEl.value;
  const indirizzi=datiIndirizzi.filter(d=>d.Progetto===valPro && d.Struttura===valStr && d.Ente===valEn).map(d=>d.Indirizzo);
  indirizzoEl.innerHTML="<option value=''>SELEZIONARE</option>";
  indirizzi.forEach(i=>indirizzoEl.innerHTML+=`<option value="${i}">${i}</option>`);
}

// ================= Eventi cascata =================
progettoEl.addEventListener('change',()=>{popolaStrutture(); aggiornaRiepilogo();});
strutturaEl.addEventListener('change',()=>{popolaEnti(); aggiornaRiepilogo();});
enteEl.addEventListener('change',()=>{popolaIndirizzi(); aggiornaRiepilogo();});
[indirizzoEl,operatoriEl,totOreEl,mqEl,manutenzioneChk,pulizieChk,sanificazioneChk,disinfestazioneChk,derattizzazioneChk].forEach(el=>{
  el.addEventListener('change', aggiornaRiepilogo);
});

// ================= Materiali =================
function aggiungiMateriale(){
  const div=document.createElement('div'); div.className='materiale-row';
  div.innerHTML=`<input type="text" placeholder="Descrizione materiale"><input type="number" step="0.01" placeholder="Prezzo €"><button type="button" class="btn secondary">X</button>`;
  div.querySelector('button').onclick=()=>{div.remove(); aggiornaRiepilogo();};
  materialiContainer.appendChild(div);
}
aggiungiMaterialeBtn.addEventListener('click',aggiungiMateriale);

// ================= Riepilogo costi =================
function aggiornaRiepilogo(){
  riepilogoBody.innerHTML=""; let subtotal=0;
  const operatori=Number(operatoriEl.value)||0, ore=Number(totOreEl.value)||0, mq=Number(mqEl.value)||0;

  if(manutenzioneChk.checked){const val=RATES.MANUTENZIONE*operatori*ore; subtotal+=val; riepilogoBody.innerHTML+=`<tr><td>Manutenzione</td><td class="right">${val.toFixed(2)}</td></tr>`;}
  if(pulizieChk.checked){const val=RATES.PULIZIE*operatori*ore; subtotal+=val; riepilogoBody.innerHTML+=`<tr><td>Pulizie</td><td class="right">${val.toFixed(2)}</td></tr>`;}
  if(sanificazioneChk.checked){const val=RATES.SANIFICAZIONE*mq; subtotal+=val; riepilogoBody.innerHTML+=`<tr><td>Sanificazione</td><td class="right">${val.toFixed(2)}</td></tr>`;}
  if(disinfestazioneChk.checked){const val=RATES.DISINFESTAZIONE*mq; subtotal+=val; riepilogoBody.innerHTML+=`<tr><td>Disinfestazione</td><td class="right">${val.toFixed(2)}</td></tr>`;}
  if(derattizzazioneChk.checked){const val=RATES.DERATTIZZAZIONE*mq; subtotal+=val; riepilogoBody.innerHTML+=`<tr><td>Derattizzazione</td><td class="right">${val.toFixed(2)}</td></tr>`;}
  
  // Materiali
  document.querySelectorAll('#materiali-container .materiale-row').forEach(row=>{
    const desc=row.querySelector('input[type=text]').value;
    const val=parseFloat(row.querySelector('input[type=number]').value)||0;
    if(desc!==""){ subtotal+=val; riepilogoBody.innerHTML+=`<tr><td>${desc}</td><td class="right">${val.toFixed(2)}</td></tr>`;}
  });

  subtotalEl.textContent=subtotal.toFixed(2);
  const iva=subtotal*0.22; ivaEl.textContent=iva.toFixed(2);
  totalEl.textContent=(subtotal+iva).toFixed(2);
}

// ================= Firme =================
function pulisciFirma(id){
  const c=document.getElementById(id); const ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
}
['firmaOperatore','firmaCliente'].forEach(id=>{
  const c=document.getElementById(id); const ctx=c.getContext('2d'); let dis=false;
  c.addEventListener('mousedown',()=>dis=true); c.addEventListener('mouseup',()=>dis=false); c.addEventListener('mouseout',()=>dis=false);
  c.addEventListener('mousemove',e=>{if(!dis)return; const rect=c.getBoundingClientRect(); ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='black'; ctx.lineTo(e.clientX-rect.left,e.clientY-rect.top); ctx.stroke(); ctx.beginPath(); ctx.moveTo(e.clientX-rect.left,e.clientY-rect.top);});
});

// ================= Stampa / JSON =================
document.getElementById('print').addEventListener('click',()=>window.print());

document.getElementById('exportJson').addEventListener('click',()=>{
  const materiali=[];
  document.querySelectorAll('#materiali-container .materiale-row').forEach(row=>{
    materiali.push({desc:row.querySelector('input[type=text]').value, prezzo: parseFloat(row.querySelector('input[type=number]').value)||0});
  });
  const data={
    progetto:progettoEl.value,
    struttura:strutturaEl.value,
    ente:enteEl.value,
    indirizzo:indirizzoEl.value,
    descrizione:document.getElementById('descrizione').value,
    data_lavoro:document.getElementById('dataLavoro').value,
    ora_inizio:document.getElementById('oraInizio').value,
    ora_fine:document.getElementById('oraFine').value,
    operatori:operatoriEl.value,
    ore:totOreEl.value,
    mq:mqEl.value,
    tipo_lavoro:{
      manutenzione:manutenzioneChk.checked,
      pulizie:pulizieChk.checked,
      sanificazione:sanificazioneChk.checked,
      disinfestazione:disinfestazioneChk.checked,
      derattizzazione:derattizzazioneChk.checked
    },
    materiali:materiali,
    totale:totalEl.textContent
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ordine.json'; a.click();
});
</script>
</body>
</html>
